---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r libraries}
library(ggplot2)
library(gridExtra)
library(dplyr)
library(tidyr)
library(purrr)
library(deSolve)
library(rstan)
library(rethinking)
library(stringr)
library(ggsci)
library(readr)
library(MLmetrics)
library(ggalt)
devtools::load_all("../R_packages/readsdr")
source("./graphs.R")
```

# 1. Synthetic data

## 1.1 Parameters

## 1.1.1 Average contacts per age group

```{r, fig.height = 4.5, fig.width = 5, fig.align= "center"}
source("./R/synthetic_params.R")

output_sp <- produce_synthetic_params()
output_sp$g_original_contacts
```

## 1.1.2 Average contacts per age group - aggregated

```{r, fig.height = 2.5, fig.width = 3, fig.align= "center"}
output_sp$g_M_matrix
```



## 1.1.3 Synthetic WAIFW (Scaled by a factor of 10 ^ 5)

```{r g_synWAIFW, fig.height = 2.5, fig.width = 3, fig.align= "center"}
output_sp$g_syn_WAIFW
```

## 1.2 Synthetic incidence from 4-cohort SEIR

```{r}
source("./R/synthetic_incidence.R")
output_gsi     <- generate_synthetic_incidence(output_sp)
incidence_data <- output_gsi$incidence_df

incidence_list <- lapply(1:4, function(i, incidence_data) {
  filter(incidence_data, index_group == i) %>% pull(incidence)
}, incidence_data = incidence_data)

age_0_4_data     <- incidence_list[[1]]
age_5_14_data    <- incidence_list[[2]]
age_15_44_data   <- incidence_list[[3]]
age_45_over_data <- incidence_list[[4]]

data_list <- list(age_0_4_data = age_0_4_data,
                  age_5_14_data = age_5_14_data,
                  age_15_44_data = age_15_44_data,
                  age_45_over_data = age_45_over_data)

cml_data <- output_gsi$cumulative_df

cml_list <- lapply(1:4, function(i, cml_data) {
  filter(cml_data, index_group == i) %>% pull(cml_incidence)
}, cml_data = cml_data)

cml_age_0_4_data     <- cml_list[[1]]
cml_age_5_14_data    <- cml_list[[2]]
cml_age_15_44_data   <- cml_list[[3]]
cml_age_45_over_data <- cml_list[[4]]

length_data <- length(age_0_4_data)
output_gsi$g_incidences
```

\newpage
# 2 Calibration

## 2.1 Matrix structures

```{r}
age_groups <- c("0-4", "5-14", "15-64", "65+")

# Symmetrical matrix
conceptual_matrix_sym <- c("B11", "B12", "B13", "B14",
                           "B12", "B22", "B23", "B24",
                           "B13", "B23", "B33", "B34",
                           "B14", "B24", "B34", "B44")

# Kannan & Farrington (2005)
conceptual_matrix_A <- c("B11", "B11", "B33", "B44",
                         "B11", "B22", "B33", "B44",
                         "B33", "B33", "B33", "B44",
                         "B44", "B44", "B44", "B44")

conceptual_matrix_B <- c("B11", "B11", "B11", "B11",
                         "B11", "B22", "B22", "B22",
                         "B11", "B22", "B33", "B44",
                         "B11", "B22", "B44", "B44")

conceptual_matrix_C <- c("B11", "B22", "B13", "B22",
                         "B22", "B22", "B22", "B22",
                         "B13", "B22", "B44", "B44",
                         "B22", "B22", "B44", "B44")

conceptual_matrix_D <- c("B11", "B44", "B44", "B44",
                         "B44", "B22", "B44", "B44",
                         "B44", "B44", "B33", "B44",
                         "B44", "B44", "B44", "B44")

# Conceptual matrix list
cm_list <- list(conceptual_matrix_sym, conceptual_matrix_A, conceptual_matrix_B, conceptual_matrix_C,
                conceptual_matrix_D)

titles <- c(
  "Symmetric matrix - 10 parameters",
  "Matrix A - 4 parameters",
  "Matrix B - 4 parameters",
  "Matrix C - 4 parameters",
  "Matrix D - 4 parameters")

g_cm <- map2(cm_list, titles, function(cm, gtitle) {
  contact_matrix <- matrix(cm, nrow = 4)
  colnames(contact_matrix) <- rownames(contact_matrix) <- age_groups
  WAIFW_df    <- melt(contact_matrix)
  
  colours <- pal_jco()(length(unique(cm)))
  
  g_matrix <- ggplot(data = WAIFW_df, 
       aes(x = Var1, y = ordered(Var2, levels = rev(sort(unique(Var2)))))) + 
    geom_tile(aes(fill = value), colour = "black") +
    geom_text(aes(label = value), colour = "white", size = 5)
    
  g_matrix <- g_matrix + scale_fill_manual(values = colours) 
  
    
  g_matrix <- g_matrix +
    theme_minimal() + 
    labs(y ="", x = "", subtitle = gtitle) +
    theme(legend.position = "none")
})


g_matrices <- grid.arrange(g_cm[[1]], g_cm[[2]], g_cm[[3]], g_cm[[4]], g_cm[[5]], ncol = 2)
print(g_matrices)

ggsave("./plots/g_matrices.png", dpi = "print", height = 5, width = 5, 
       plot = g_matrices)
```


## 2.2 Through Stan


## 2.2.1 Symmetric matrix

```{r stan_fit_sym, cache = TRUE}
source("./R/write_SEIR_model.R")

filename     <- "SEIR_2.1.stan"
params_prior <- "  params ~ normal(0, 100)"
o_SEIR_sym   <- write_SEIR_model("sym", filename, output_gsi$stocks, params_prior)

stan_d <- list(n_obs    = length_data,
              n_params = length(unique(conceptual_matrix_sym)), 
              n_difeq  = 16, # number of differential equations
              y1       = age_0_4_data,
              y2       = age_5_14_data,
              y3       = age_15_44_data,
              y4       = age_45_over_data,
              t0       = 0,
              ts       = 1:length_data)

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
stan_fit_sym <- stan(fit = test, data = stan_d, chains = 3, warmup = 1000,
                   iter   = 2000, cores  = 3, seed = 936357172, refresh = 5)
```

```{r}
source("./R/summarise_results.R")

specs_list <- list(x_pos = 2.28, ypos_mean = 14, ypos_median = 13.5, 
                   text_size = 2, ypos_interval = 13, 
                   title = "Symmetric matrix", xlabel = "")

summary_2.1 <- summarise_results(stan_fit_sym, conceptual_matrix_sym, 
                        output_gsi$incidence_df, output_sp$syn_pop$syn_pop,
                        specs_list, o_SEIR_sym$params)
summary_2.1$g_WAIFW
```

```{r g_comparison_SIR_dis_2_days}
summary_2.1$g_comparison
```

```{r}
summary_2.1$g_rNougths
```

## 2.2.2 Matrix A

```{r stan_fit_A, cache = TRUE}
source("./R/write_SEIR_model.R")

filename     <- "SEIR_2.2.stan"
params_prior <- "  params ~ normal(0, 100)"
o_SEIR_A     <- write_SEIR_model("A", filename, output_gsi$stocks, params_prior)

stan_d <- list(n_obs    = length_data,
              n_params = length(unique(conceptual_matrix_A)), 
              n_difeq  = 16, # number of differential equations
              y1       = age_0_4_data,
              y2       = age_5_14_data,
              y3       = age_15_44_data,
              y4       = age_45_over_data,
              t0       = 0,
              ts       = 1:length_data)

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
stan_fit_A <- stan(fit = test, data = stan_d, chains = 3, warmup = 1000,
                   iter   = 2000, cores  = 3, seed = 1677265155, refresh = 5)
```

```{r}
source("./R/summarise_results.R")

specs_list <- list(x_pos = 2.25, ypos_mean = 28, ypos_median = 26, 
                   text_size = 2, ypos_interval = 24, 
                   title = "Matrix A", xlabel = "")

summary_2.2 <- summarise_results(stan_fit_A, conceptual_matrix_A, 
                        output_gsi$incidence_df, output_sp$syn_pop$syn_pop,
                        specs_list, o_SEIR_A$params)
summary_2.2$g_WAIFW
```


```{r}
summary_2.2$g_comparison
```

```{r}
summary_2.2$g_rNougths
```

## 2.2.3 Matrix B

```{r stan_fit_B, cache = TRUE}
source("./R/write_SEIR_model.R")
filename     <- "SEIR_2.3.stan"
params_prior <- "  params ~ normal(0, 100)"
o_SEIR_B     <- write_SEIR_model("B", filename, output_gsi$stocks, params_prior)

stan_d <- list(n_obs    = length_data,
              n_params = length(o_SEIR_B$params), 
              n_difeq  = 16, # number of differential equations
              y1       = age_0_4_data,
              y2       = age_5_14_data,
              y3       = age_15_44_data,
              y4       = age_45_over_data,
              t0       = 0,
              ts       = 1:length_data)

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
stan_fit_B <- stan(fit = test, data = stan_d, chains = 3, warmup = 1000,
                   iter   = 2000, cores  = 3, seed = 1298600912, refresh = 5)
```

```{r}
source("./R/summarise_results.R")

specs_list <- list(x_pos = 2.25, ypos_mean = 28, ypos_median = 26, 
                   text_size = 2, ypos_interval = 24, 
                   title = "Matrix C", xlabel = "")

summary_2.3 <- summarise_results(stan_fit_B, conceptual_matrix_B, 
                        output_gsi$incidence_df, output_sp$syn_pop$syn_pop,
                        specs_list, o_SEIR_B$params)
summary_2.3$g_WAIFW
```

```{r}
summary_2.3$g_comparison
```

```{r}
summary_2.3$g_rNougths
```

### 2.2.4 Matrix C

```{r stan_fit_C, cache = TRUE}
source("./R/write_SEIR_model.R")
filename     <- "SEIR_2.4.stan"
params_prior <- "  params ~ normal(0, 100)"
o_SEIR_C     <- write_SEIR_model("C", filename, output_gsi$stocks, params_prior)

stan_d <- list(n_obs    = length_data,
              n_params = length(o_SEIR_C$params), 
              n_difeq  = 16, # number of differential equations
              y1       = age_0_4_data,
              y2       = age_5_14_data,
              y3       = age_15_44_data,
              y4       = age_45_over_data,
              t0       = 0,
              ts       = 1:length_data)

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
stan_fit_C <- stan(fit = test, data = stan_d, chains = 3, warmup = 1000,
                   iter   = 2000, cores  = 3, seed = 615190292, refresh = 5)
```

```{r}
source("./R/summarise_results.R")

specs_list <- list(x_pos = 2.25, ypos_mean = 28, ypos_median = 26,
                     text_size = 2, ypos_interval = 24, 
                     title = "Matrix C", xlabel = "")

summary_2.4 <- summarise_results(stan_fit_C, conceptual_matrix_C, 
                        output_gsi$incidence_df, output_sp$syn_pop$syn_pop,
                        specs_list, o_SEIR_C$params)
summary_2.4$g_WAIFW
```

```{r}
summary_2.4$g_comparison
```

```{r}
summary_2.4$g_rNougths
```

### 2.2.5 Matrix D

```{r stan_fit_D, cache = TRUE}
source("./R/write_SEIR_model.R")
filename     <- "SEIR_D.stan"
params_prior <- "  params ~ normal(0, 100)"
o_SEIR_D     <- write_SEIR_model("D", filename, output_gsi$stocks, params_prior)

stan_d <- list(n_obs    = length_data,
              n_params = length(o_SEIR_D$params), 
              n_difeq  = 16, # number of differential equations
              y1       = age_0_4_data,
              y2       = age_5_14_data,
              y3       = age_15_44_data,
              y4       = age_45_over_data,
              t0       = 0,
              ts       = 1:length_data)

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
stan_fit_D <- stan(fit = test, data = stan_d, chains = 3, warmup = 1000,
                   iter   = 2000, cores  = 3, seed = 12011989, refresh = 5)
```


```{r}
source("./R/summarise_results.R")

specs_list <- list(x_pos = 2.25, ypos_mean = 28, ypos_median = 26,
                     text_size = 2, ypos_interval = 24, 
                     title = "Matrix D", xlabel = "")

summary_2.5 <- summarise_results(stan_fit_D, conceptual_matrix_D, 
                        output_gsi$incidence_df, output_sp$syn_pop$syn_pop,
                        specs_list, o_SEIR_D$params)
summary_2.5$g_WAIFW
```

```{r}
summary_2.5$g_comparison
```

```{r}
summary_2.5$g_rNougths
```

```{r stan_r_noughts}
matrices <- paste0("Matrix ", LETTERS[1:4])

R_estimations_stan <- data.frame(matrix = c("Symmetric", matrices), 
                            R0 = c(
                              summary_2.1$mean_rNought,
                              summary_2.2$mean_rNought,
                              summary_2.3$mean_rNought,
                              summary_2.4$mean_rNought,
                              summary_2.5$mean_rNought),
                            lower.bound = c(
                              summary_2.1$lower_bound,
                              summary_2.2$lower_bound,
                              summary_2.3$lower_bound,
                              summary_2.4$lower_bound,
                              summary_2.5$lower_bound),
                            upper.bound = c(
                              summary_2.1$upper_bound,
                              summary_2.2$upper_bound,
                              summary_2.3$upper_bound,
                              summary_2.4$upper_bound,
                              summary_2.5$upper_bound),
                            method = "Hamiltonian Monte Carlo")
```

```{r MSE_timeseries_stan}
matrices <- paste0("Matrix ", LETTERS[1:4])

MSE_ts_stan <- data.frame(matrix = c("Symmetric", matrices), 
                            MSE = c(
                              summary_2.1$MSE,
                              summary_2.2$MSE,
                              summary_2.3$MSE,
                              summary_2.4$MSE,
                              summary_2.5$MSE),
                            method = "Hamiltonian Monte Carlo")
```

## 2.3 By optimisation

## 2.3.1 Symmetric matrix

```{r optim_sym, cache = TRUE}
source("./R/optimise_SEIR.R")

optim_fit_sym <- optimise_SEIR("sym", data_list, init.WAIFW = 15)
```


```{r}
source("./R/summarise_optim_fit.R")
summary_optim_sym <- summarise_optim_fit(optim_fit_sym, incidence_data, 
                                       conceptual_matrix_sym, 
                                       output_sp$syn_pop$syn_pop)
summary_optim_sym$g_comparison
```

## 2.3.2 Matrix A

```{r optim_A, cache = TRUE}
source("./R/optimise_SEIR.R")

optim_fit_A <- optimise_SEIR("A", data_list)
```

```{r}
source("./R/summarise_optim_fit.R")
summary_optim_A <- summarise_optim_fit(optim_fit_A, incidence_data, 
                                       conceptual_matrix_A, 
                                       output_sp$syn_pop$syn_pop)
summary_optim_A$g_comparison
```

```{r}
summary_optim_sym$g_WAIFW
```


```{r}
summary_optim_A$g_WAIFW
```

## 2.3.3 Matrix B

```{r optim_B, cache = TRUE}
source("./R/optimise_SEIR.R")

optim_fit_B <- optimise_SEIR("B", data_list, init.WAIFW = 15)
```

```{r}
source("./R/summarise_optim_fit.R")
summary_optim_B <- summarise_optim_fit(optim_fit_B, incidence_data, 
                                       conceptual_matrix_B, 
                                       output_sp$syn_pop$syn_pop)
summary_optim_B$g_comparison
```
```{r}
summary_optim_B$g_WAIFW
```

## 2.3.4 Matrix C

```{r optim_C, cache = TRUE}
source("./R/optimise_SEIR.R")

optim_fit_C <- optimise_SEIR("C", data_list, init.WAIFW = 20)
```

```{r}
source("./R/summarise_optim_fit.R")
summary_optim_C <- summarise_optim_fit(optim_fit_C, incidence_data, 
                                       conceptual_matrix_C, 
                                       output_sp$syn_pop$syn_pop)
summary_optim_C$g_comparison
```

```{r}
summary_optim_C$g_WAIFW
```

## 2.3.5 Matrix D

```{r optim_D, cache = TRUE}
source("./R/optimise_SEIR.R")

optim_fit_D <- optimise_SEIR("D", data_list, init.WAIFW = 35)
```

```{r}
source("./R/summarise_optim_fit.R")

summary_optim_D <- summarise_optim_fit(optim_fit_D, incidence_data, 
                                       conceptual_matrix_D, 
                                       output_sp$syn_pop$syn_pop)
summary_optim_D$g_comparison
```


```{r}
summary_optim_D$g_WAIFW
```



```{r optim_r_noughts}
matrices <- paste0("Matrix ", LETTERS[1:4])

R_estimations_optim <- data.frame(matrix = c("Symmetric", matrices), 
                            R0 = c(
                              summary_optim_sym$R_nought,
                              summary_optim_A$R_nought,
                              summary_optim_B$R_nought,
                              summary_optim_C$R_nought,
                              summary_optim_D$R_nought),
                            method = "MLE")
```

```{r MSE_timeseries_optim}
matrices <- paste0("Matrix ", LETTERS[1:4])

MSE_ts_optim <- data.frame(matrix = c("Symmetric", matrices), 
                            MSE = c(
                              summary_optim_sym$MSE,
                              summary_optim_A$MSE,
                              summary_optim_B$MSE,
                              summary_optim_C$MSE,
                              summary_optim_D$MSE),
                            method = "MLE")
```

## 2.4 Incidence goodness of fit

```{r}
MSE_ts <- bind_rows(MSE_ts_optim, MSE_ts_stan)

ggplot(MSE_ts, aes(x = matrix, y = MSE)) +
  geom_lollipop() +
  coord_flip() +
  geom_text(aes(label = round(MSE, 0)), nudge_y = 50, size = 3) +
  facet_wrap(~ method)
```



## 2.5 $R_{0}$ estimation

```{r}

R_nought_est <- bind_rows(R_estimations_stan, R_estimations_optim)

ggplot(R_nought_est, aes(x = matrix, y = R0)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower.bound, ymax = upper.bound), width =.1) +
  geom_hline(yintercept = output_sp$theoretical_R0, linetype = "dashed") +
  scale_y_continuous(limits = c(2, 2.3)) +
  facet_wrap(~method) +
  theme_test() +
  labs(x = "Structure")
```

## 2.6 MSE in WAIFW's

```{r}
stan_WAIFWs <- list(summary_2.1$WAIFW, summary_2.2$WAIFW,
                       summary_2.3$WAIFW, summary_2.4$WAIFW,
                       summary_2.5$WAIFW)

actual_WAIFW <- as.vector(output_sp$synthetic_WAIFW) * 1e5

MSE_stan <- map_dbl(stan_WAIFWs, function(WAIFW, actual_WAIFW) {
  MSE(as.vector(WAIFW), actual_WAIFW)
}, actual_WAIFW = actual_WAIFW)

MSE_stan_df <- tibble(matrix = c("Symmetric", matrices),
                      MSE = MSE_stan,
                      method = "Hamiltonian Monte Carlo")

optim_WAIFWs <- list(summary_optim_sym$WAIFW, summary_optim_A$WAIFW,
                     summary_optim_B$WAIFW, summary_optim_C$WAIFW,
                     summary_optim_D$WAIFW)

MSE_optim <- map_dbl(optim_WAIFWs, function(WAIFW, actual_WAIFW) {
  MSE(as.vector(WAIFW), actual_WAIFW)
}, actual_WAIFW = actual_WAIFW)

MSE_optim_df <- tibble(matrix = c("Symmetric", matrices),
                      MSE = MSE_optim,
                      method = "MLE")

MSE_df <- bind_rows(MSE_stan_df, MSE_optim_df)

ggplot(MSE_df, aes(x = matrix, y = MSE)) +
  geom_lollipop() +
  coord_flip() +
  facet_wrap(~ method)
```


```{r, cache = TRUE}
# source("./R/write_SEIR_CML_model.R")
# 
# filename      <- "SEIR_3.1.stan"
# params_prior  <- "  params ~ normal(0, 25)"
# stocks        <- output_gsi$stocks
# stocks["CI1"] <- stocks["I1"]
# stocks["CI2"] <- stocks["I2"]
# stocks["CI3"] <- stocks["I3"]
# stocks["CI4"] <- stocks["I4"]
# o_SEIR_cml_A  <- write_SEIR_CML_model("A", filename, stocks, params_prior)
# 
# stan_d <- list(n_obs    = length_data,
#               n_params = 16, 
#               n_difeq  = 20, # number of differential equations
#               y1       = cml_age_0_4_data,
#               y2       = cml_age_5_14_data,
#               y3       = cml_age_15_44_data,
#               y4       = cml_age_45_over_data,
#               t0       = 0,
#               ts       = 1:length_data)
# 
# # Test / debug the model:
# test <- stan(filename, data = stan_d, chains = 1, iter = 10,
#                verbose = FALSE, refresh = 0)
# 
# # Fit and sample from the posterior
# stan_fit_3.1 <- stan(fit = test, data = stan_d, chains = 3, warmup = 1000,
#                    iter   = 2000, cores  = 3, seed = 772868256, refresh = 5)
```





