---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r libraries}
library(ggplot2)
library(gridExtra)
library(dplyr)
library(tidyr)
library(purrr)
library(deSolve)
devtools::load_all("../../R_Packages/readsdr/")
```

# 1. Synthetic data

## 1.1 Parameters

## 1.1.1 Average contacts per age group

```{r, fig.height = 4.5, fig.width = 5, fig.align= "center"}
source("./R/synthetic_params.R")

output_sp <- produce_synthetic_params()
output_sp$g_original_contacts
```

## 1.1.2 Average contacts per age group - aggregated

```{r, fig.height = 2.5, fig.width = 3, fig.align= "center"}
output_sp$g_aggregated_contacts
```



## 1.1.3 Synthetic WAIFW (Scaled by a factor of 10 ^ 5)

```{r g_synWAIFW, fig.height = 2.5, fig.width = 3, fig.align= "center"}
output_sp$g_syn_WAIFW
```

## 1.2 Synthetic incidence from 4-cohort SEIR

```{r}
source("./R/synthetic_incidence.R")
output_gsi <- generate_synthetic_incidence(output_sp)
output_gsi$g_incidences
```

\newpage
# 2 Fitting

```{r}
source("./stan_utils.R")
constants <- output_gsi$constants
constants <- constants[!constants %in% c("recovery_time", "latent_period")]

model_file <- "./deterministic_models/4_cohorts_SEIR_full_params.stmx"
override_consts <- list(
  list(name = "recovery_time", value = 2),
  list(name = "latent_period", value = 1))
stan_fun   <- create_stan_function(model_file, "SEIR_four_cohorts", 
                                   pars = constants,
                                   override.consts = override_consts)

stan_data  <- paste(
  "data {",
  "  int<lower = 1> n_obs; // Number of weeks sampled",
  "  int<lower = 1> n_params; // Number of model parameters",
  "  int<lower = 1> n_difeq; // Number of differential equations in the system",
  "  int y1[n_obs];",
  "  int y2[n_obs];",
  "  int y3[n_obs];",
  "  int y4[n_obs];",
  "  real t0; // Initial time point (zero)",
  "  real ts[n_obs]; // Time points that were sampled",
  "}", sep = "\n")

stan_td     <- generate_transformed_data_block()
stan_params <- generate_parameters_block("poisson")

stocks      <- output_gsi$stocks

counter <- 0

stan_init_stocks <- sapply(stocks, function(stock) {
  counter <<- counter + 1
  paste0("  y0[", counter, "] = ", stock, ";")
}) %>% paste(collapse = "\n")

stan_tp <- paste(
  "transformed parameters{",
  "  real y_hat[n_obs, n_difeq]; // Output from the ODE solver",
  "  real y0[n_difeq]; // Initial conditions",
  "  real incidence1[n_obs];",
  "  real incidence2[n_obs];",
  "  real incidence3[n_obs];",
  "  real incidence4[n_obs];",
  stan_init_stocks,
  "  y_hat = integrate_ode_rk45(SEIR_four_cohorts, y0, t0, ts, params, x_r, x_i);",
  "  incidence1[1] =  y_hat[1, 3] + y_hat[1, 4] - y0[3] - y0[4];",
  "  incidence2[1] =  y_hat[1, 7] + y_hat[1, 8] - y0[7] - y0[8];",
  "  incidence3[1] =  y_hat[1, 11] + y_hat[1, 12] - y0[11] - y0[12];",
  "  incidence4[1] =  y_hat[1, 15] + y_hat[1, 16] - y0[15] - y0[16];",
  "  for (i in 1:n_obs-1) {",
  "    incidence1[i + 1] = y_hat[i + 1, 3] + y_hat[i + 1, 4] - y_hat[i, 3] - y_hat[i, 4] + 0.00001;",
  "    incidence2[i + 1] = y_hat[i + 1, 7] + y_hat[i + 1, 8] - y_hat[i, 7] - y_hat[i, 8] + 0.00001;",
  "    incidence3[i + 1] = y_hat[i + 1, 11] + y_hat[i + 1, 12] - y_hat[i, 11] - y_hat[i, 12] + 0.00001;",
  "    incidence4[i + 1] = y_hat[i + 1, 15] + y_hat[i + 1, 16] - y_hat[i, 15] - y_hat[i, 16] + 0.00001;",
  "   }",
  "}", sep = "\n")

stan_model_text <- c(
"  params ~ normal(0, 25)",
"  y1     ~ poisson(incidence1)",
"  y2     ~ poisson(incidence2)",
"  y3     ~ poisson(incidence3)",
"  y4     ~ poisson(incidence4)"
)
stan_model  <- generate_model_text(stan_model_text)

stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp, stan_model, sep = "\n")

filename <- "SEIR_HD_2.stan"
create_stan_file(stan_text, filename)

incidence_data <- output_gsi$incidence_df

incidence_list <- lapply(1:4, function(i, incidence_data) {
  filter(incidence_data, index_group == i) %>% pull(incidence)
}, incidence_data = incidence_data)

age_0_4_data     <- incidence_list[[1]]
age_5_14_data    <- incidence_list[[2]]
age_15_44_data   <- incidence_list[[3]]
age_45_over_data <- incidence_list[[4]]

length_data <- length(age_0_4_data)

stan_d <- list(n_obs    = length_data,
              n_params = length(constants), 
              n_difeq  = 16, # number of differential equations
              y1       = age_0_4_data,
              y2       = age_5_14_data,
              y3       = age_15_44_data,
              y4       = age_45_over_data,
              t0       = 0,
              ts       = 1:length_data)

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
stan_fit_2 <- stan(fit = test, data = stan_d, chains = 3, warmup = 1000,
                   iter   = 2000, cores  = 3, seed = 936357172, refresh = 5)
```

```{r}
posterior_df <- as.data.frame(stan_fit_2)
mean(posterior_df$`params[2]`) * 1e5

mean_incidences <- posterior_df %>% select(contains("incidence")) %>% 
  colMeans()

names_mi <- names(mean_incidences)

age_groups <- c("Age.0.4", "Age.5.14", "Age.15.44", "Age.45.over")

sim_data <- map_df(age_groups, function(ag) {
  i <- which(ag == age_groups)
  regex <- stringr::regex(paste0("incidence", i, "\\["))
  data.frame(week = 1:50, value = mean_incidences[grepl(regex, names_mi)], 
                            variable = ag)
}) %>% mutate(source = "sim data")

ggplot(sim_data, aes(x = week, y = value)) +
  geom_line() +
  facet_wrap(~ variable)

samples                 <- rstan::extract(stan_fit_2)
param_samples           <- samples$params
colnames(param_samples) <- constants
param_medians           <- apply(param_samples, 2, function(col) median(col))

conceptual_matrix <- c("B11", "B12", "B13", "B14",
                       "B21", "B22", "B23", "B24",
                       "B31", "B32", "B33", "B34",
                       "B41", "B42", "B43", "B44")


WAIFW_medians <- sapply(
  conceptual_matrix, function(Bij, row) row[[Bij]], row = param_medians) %>%
  matrix(nrow = 4)
  
  normalised_WAIFW <- WAIFW_medians * 1e0
  colnames(normalised_WAIFW) <- rownames(normalised_WAIFW) <- age_groups
  
  draw_WAIFW(normalised_WAIFW, "title")
```

```{r}
pop_sizes <- c(output_sp$syn_pop$syn_pop)

r_noughts <- sapply(1:nrow(param_samples), function(i) {
  row <- param_samples[i, ]
  WAIFW <- sapply(conceptual_matrix, 
                function(Bij, row) row[[Bij]], row = row) %>%
  matrix(nrow = 4, byrow = TRUE)
  next_gen_matrix <- WAIFW / 1e5 * pop_sizes * 2
  eigensystem <- eigen(next_gen_matrix)
  max(abs(eigensystem$values))
})

specs_list <- list(x_pos = 2.28, ypos_mean = 14, ypos_median = 13.5, 
                   text_size = 2, ypos_interval = 13, 
                   title = "16 parameters", xlabel = "")

draw_density(r_noughts, specs_list)
```

