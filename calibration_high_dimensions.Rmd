---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r libraries}
library(ggplot2)
library(gridExtra)
library(dplyr)
library(tidyr)
library(purrr)
library(deSolve)
library(rstan)
library(rethinking)
devtools::load_all("../R_packages/readsdr")
source("./graphs.R")
source("./R/stan_models.R")
```

# 1. Synthetic data

## 1.1 Parameters

## 1.1.1 Average contacts per age group

```{r, fig.height = 4.5, fig.width = 5, fig.align= "center"}
source("./R/synthetic_params.R")

output_sp <- produce_synthetic_params()
output_sp$g_original_contacts
```

## 1.1.2 Average contacts per age group - aggregated

```{r, fig.height = 2.5, fig.width = 3, fig.align= "center"}
output_sp$g_aggregated_contacts
```



## 1.1.3 Synthetic WAIFW (Scaled by a factor of 10 ^ 5)

```{r g_synWAIFW, fig.height = 2.5, fig.width = 3, fig.align= "center"}
output_sp$g_syn_WAIFW
```

## 1.2 Synthetic incidence from 4-cohort SEIR

```{r}
source("./R/synthetic_incidence.R")
output_gsi     <- generate_synthetic_incidence(output_sp)
incidence_data <- output_gsi$incidence_df

incidence_list <- lapply(1:4, function(i, incidence_data) {
  filter(incidence_data, index_group == i) %>% pull(incidence)
}, incidence_data = incidence_data)

age_0_4_data     <- incidence_list[[1]]
age_5_14_data    <- incidence_list[[2]]
age_15_44_data   <- incidence_list[[3]]
age_45_over_data <- incidence_list[[4]]

length_data <- length(age_0_4_data)
output_gsi$g_incidences
```

\newpage
# 2 Fitting incidence data

## 2.1 Matrix A

```{r, cache = TRUE}
source("./R/write_SEIR_model.R")

filename     <- "SEIR_2.1.stan"
params_prior <- "  params ~ normal(0, 25)"
o_SEIR_A     <- write_SEIR_model("A", filename, output_gsi$stocks, params_prior)

stan_d <- list(n_obs    = length_data,
              n_params = 16, 
              n_difeq  = 16, # number of differential equations
              y1       = age_0_4_data,
              y2       = age_5_14_data,
              y3       = age_15_44_data,
              y4       = age_45_over_data,
              t0       = 0,
              ts       = 1:length_data)

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
stan_fit_2.1 <- stan(fit = test, data = stan_d, chains = 3, warmup = 1000,
                   iter   = 2000, cores  = 3, seed = 936357172, refresh = 5)
```

```{r}
source("./R/summarise_results.R")

conceptual_matrix <- c("B11", "B12", "B13", "B14",
                       "B21", "B22", "B23", "B24",
                       "B31", "B32", "B33", "B34",
                       "B41", "B42", "B43", "B44")

specs_list <- list(x_pos = 2.28, ypos_mean = 14, ypos_median = 13.5, 
                   text_size = 2, ypos_interval = 13, 
                   title = "Matrix A", xlabel = "")

summary_2.1 <- summarise_results(stan_fit_2.1, conceptual_matrix, 
                        output_gsi$incidence_df, output_sp$syn_pop$syn_pop,
                        specs_list, o_SEIR_A$params)
summary_2.1$g_WAIFW
```

```{r g_comparison_SIR_dis_2_days}
summary_2.1$g_comparison
```

```{r}
summary_2.1$g_rNougths
```

## 2.2 Matrix B

```{r}
source("./R/write_SEIR_model.R")

filename     <- "SEIR_2.2.stan"
params_prior <- "  params ~ normal(0, 1000)"
o_SEIR_B     <- write_SEIR_model("B", filename, output_gsi$stocks, params_prior)

stan_d <- list(n_obs    = length_data,
              n_params = 10, 
              n_difeq  = 16, # number of differential equations
              y1       = age_0_4_data,
              y2       = age_5_14_data,
              y3       = age_15_44_data,
              y4       = age_45_over_data,
              t0       = 0,
              ts       = 1:length_data)

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
stan_fit_2.2 <- stan(fit = test, data = stan_d, chains = 3, warmup = 1000,
                   iter   = 2000, cores  = 3, seed = 1677265155, refresh = 5)
```

```{r}
source("./R/summarise_results.R")

conceptual_matrix <- c("B11", "B12", "B13", "B14",
                       "B12", "B22", "B23", "B24",
                       "B13", "B23", "B33", "B34",
                       "B14", "B24", "B34", "B44")

specs_list <- list(x_pos = 2.25, ypos_mean = 28, ypos_median = 26, 
                   text_size = 2, ypos_interval = 24, 
                   title = "Matrix B", xlabel = "")

summary_2.2 <- summarise_results(stan_fit_2.2, conceptual_matrix, 
                        output_gsi$incidence_df, output_sp$syn_pop$syn_pop,
                        specs_list, o_SEIR_B$params)
summary_2.2$g_WAIFW
```


```{r}
summary_2.2$g_comparison
```

```{r}
summary_2.2$g_rNougths
```

## 2.3 Matrix C

```{r}
source("./R/write_SEIR_model.R")
filename     <- "SEIR_2.3.stan"
params_prior <- "  params ~ normal(0, 100)"
o_SEIR_C     <- write_SEIR_model("C", filename, output_gsi$stocks, params_prior)

stan_d <- list(n_obs    = length_data,
              n_params = length(o_SEIR_C$params), 
              n_difeq  = 16, # number of differential equations
              y1       = age_0_4_data,
              y2       = age_5_14_data,
              y3       = age_15_44_data,
              y4       = age_45_over_data,
              t0       = 0,
              ts       = 1:length_data)

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
stan_fit_2.3 <- stan(fit = test, data = stan_d, chains = 3, warmup = 1000,
                   iter   = 2000, cores  = 3, seed = 1298600912, refresh = 5)
```

```{r}
source("./R/summarise_results.R")
conceptual_matrix <- c("B11", "B11", "B33", "B44",
                       "B11", "B22", "B33", "B44",
                       "B33", "B33", "B33", "B44",
                       "B44", "B44", "B44", "B44")

specs_list <- list(x_pos = 2.25, ypos_mean = 28, ypos_median = 26, 
                   text_size = 2, ypos_interval = 24, 
                   title = "Matrix C", xlabel = "")

summary_2.3 <- summarise_results(stan_fit_2.3, conceptual_matrix, 
                        output_gsi$incidence_df, output_sp$syn_pop$syn_pop,
                        specs_list, o_SEIR_C$params)
summary_2.3$g_WAIFW
```

```{r}
summary_2.3$g_comparison
```

```{r}
summary_2.3$g_rNougths
```

## 2.4 Matrix D

```{r}
source("./R/write_SEIR_model.R")
filename     <- "SEIR_2.4.stan"
params_prior <- "  params ~ normal(0, 100)"
o_SEIR_D     <- write_SEIR_model("D", filename, output_gsi$stocks, params_prior)

stan_d <- list(n_obs    = length_data,
              n_params = length(o_SEIR_D$params), 
              n_difeq  = 16, # number of differential equations
              y1       = age_0_4_data,
              y2       = age_5_14_data,
              y3       = age_15_44_data,
              y4       = age_45_over_data,
              t0       = 0,
              ts       = 1:length_data)

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
stan_fit_2.4 <- stan(fit = test, data = stan_d, chains = 3, warmup = 1000,
                   iter   = 2000, cores  = 3, seed = 615190292, refresh = 5)
```

```{r}
source("./R/summarise_results.R")
conceptual_matrix <- c("B11", "B44", "B44", "B44",
                       "B44", "B22", "B44", "B44",
                       "B44", "B44", "B33", "B44",
                       "B44", "B44", "B44", "B44")

specs_list <- list(x_pos = 2.25, ypos_mean = 28, ypos_median = 26,
                     text_size = 2, ypos_interval = 24, 
                     title = "Matrix D", xlabel = "")

summary_2.4 <- summarise_results(stan_fit_2.4, conceptual_matrix, 
                        output_gsi$incidence_df, output_sp$syn_pop$syn_pop,
                        specs_list, o_SEIR_D$params)
summary_2.4$g_WAIFW
```

```{r}
summary_2.4$g_comparison
```

```{r}
summary_2.4$g_rNougths
```

## 2.5 $R_{0}$ estimation

```{r}
matrices <- paste0("Matrix ", LETTERS[1:4])

R_estimations <- data.frame(matrix = matrices, 
                            R0 = c(summary_2.1$mean_rNought,
                                   summary_2.2$mean_rNought,
                                   summary_2.3$mean_rNought,
                                   summary_2.4$mean_rNought))

ggplot(R_estimations, aes(x = matrix, y = R0)) +
  geom_point() +
  geom_hline(yintercept = output_sp$theoretical_R0, linetype = "dashed") +
  theme_test()
```

