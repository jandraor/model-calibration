---
title: "Calibrating models from synthetic data"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


```{r libraries, echo = FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(ggalt)
library(rstan)
library(purrr)
library(rethinking)
library(gridExtra)
library(bayesplot)
library(tidyr)
library(reshape2)
library(ggsci)
library(deSolve)
devtools::load_all("../R_packages/readsdr")
source('./stan_utils.R')
```

```{r}
generate_recovery_df <- function(model_obj) {
  model_obj$model_df %>% select(time, Recovered) %>% 
  filter(time - trunc(time) == 0) %>% 
  mutate(recovery = Recovered - lag(Recovered, default = Recovered[1]),
         recovery = round(recovery)) %>% 
  select(time, recovery) %>% 
  filter(time != 0)
}
```


# 1. SYNTHETIC DATA FROM DETERMINISTIC MODELS

```{r SIR_incidence_data, fig.height = 2.5, cache = TRUE}
source('./deterministic_models/SIR.R')
source('./deterministic_models/SEIR.R')

SIR_output          <- SIR(initInfected = 10, effectiveContacts = 1, 
                           recoveryTime = 2)
SIR_df              <- SIR_output$incidence_data %>% mutate(model = "SIR")
synthetic_incidence <- SIR_output$incidence_data$incidence 

synthetic_cum_inc   <- SIR_output$model_df %>% 
  select(time, Cumulative_Infected) %>% filter(time - trunc(time) == 0) %>% 
  slice(-1) %>% mutate(Cumulative_Infected = round(Cumulative_Infected)) %>% 
  pull(Cumulative_Infected)

SEIR_output          <- SEIR(initInfected = 10, effectiveContacts = 1, 
                             latentPeriod = 1, recoveryTime = 2)
SEIR_df              <- SEIR_output$incidence_data %>% mutate(model = "SEIR")
synthetic_incidence2 <- SEIR_output$incidence_data$incidence

SEIR_cml_infected    <- SEIR_output$model_df %>% 
  select(time, Cumulative_Infected) %>% filter(time - trunc(time) == 0) %>% 
  slice(-1) %>% mutate(Cumulative_Infected = round(Cumulative_Infected)) %>% 
  pull(Cumulative_Infected)

incidence_df <- bind_rows(SIR_df, SEIR_df)

g_incidence <- ggplot(incidence_df, aes(x = time, y = incidence, 
                                        group = model)) +
  geom_line(aes(colour = model)) +
  scale_colour_brewer(palette = "Greys") +
  geom_point(aes(shape = model)) +
  theme_test()

ggsave("./plots/g_incidence.png", dpi = "print", height = 5, width = 8)
```

## 1.1 SIR

```{r transformed_params_SIR_cum}
model_file       <- "./deterministic_models/SIR_cumulative.stmx"
mdl              <- read_xmile(model_file)
counter          <- 0
levels           <- mdl$description$levels

stan_init_stocks <- sapply(levels, function(level) {
  counter <<- counter + 1
  paste0("  y0[", counter, "] = ", level$initValue, ";")
}) %>% paste(collapse = "\n")

stan_tp_cum <- paste(
  "transformed parameters{",
  "  real y_hat[n_obs, n_difeq]; // Output from the ODE solver",
  "  real y0[n_difeq]; // Initial conditions",
  "  real cum_inc[n_obs];",
  stan_init_stocks,
  "  y_hat = integrate_ode_rk45(SIR_cum, y0, t0, ts, params, x_r, x_i);",
  "  for (i in 1:n_obs) {",
  "    cum_inc[i] = y_hat[i, 4];",
  
  "  }",
  "}", sep = "\n")

levels[[1]]$initValue <- "S0"
counter          <- 0
stan_init_stocks2 <- sapply(levels, function(level) {
  counter <<- counter + 1
  paste0("  y0[", counter, "] = ", level$initValue, ";")
}) %>% paste(collapse = "\n")

stan_tp_SIR_cml_S0 <- paste(
  "transformed parameters{",
  "  real y_hat[n_obs, n_difeq]; // Output from the ODE solver",
  "  real y0[n_difeq]; // Initial conditions",
  "  real cum_inc[n_obs];",
  stan_init_stocks2,
  "  y_hat = integrate_ode_rk45(SIR_cum, y0, t0, ts, params, x_r, x_i);",
  "  for (i in 1:n_obs) {",
  "    cum_inc[i] = y_hat[i, 4];",
  
  "  }",
  "}", sep = "\n")
```


### 1.1.1 Fitting one parameter (Effective contacts)

\hfill\break

```{r th_oneParam_SIR_normal, cache = TRUE}
source("./stan_utils.R")

func_params <- list(recovery_delay = 0.5)
stan_fun    <- generate_stan_function("SIR", func_params)
stan_data   <- generate_data_block("normal")
stan_td     <- generate_transformed_data_block()
stan_params <- generate_parameters_block("normal")
initStocks  <- list(Susceptible = 990, Infected = 10, Recovered = 0)
stan_tp     <- generate_transformed_parameters("SIR", initStocks)
stan_model  <- generate_stan_model(likelihood = "normal",
                                  n_params = 1)

stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp, stan_model, sep = "\n")

filename <- "SIR_111.stan"
create_stan_file(stan_text, filename)

stan_fit <- fit_stan_model(
  stan_file = filename, n_constants = 1, synthetic_incidence, warm_up = 2000, 
  iterations = 4000, seed = 191165034, n_difeq = 3)
```

```{r}
g_st <- stan_trace(stan_fit, pars = c("params[1]", "sigma"))
ggsave("./plots/g_trace111.png", dpi = "print", height = 5, width = 8)
```

```{r g_th_oneParam_SIR_normal, cache = TRUE}
source('./graphs.R')
posterior_df <- as.data.frame(stan_fit)
specs_list <- list(x_pos = 1.001, ypos_mean = 700, ypos_median = 630, 
                   text_size = 2, ypos_interval = 550, 
                   title = "Incidence fit - Normal", xlabel = "")

g1 <- draw_density(posterior_df$`params[1]`, specs_list)
```

```{r th_oneParam_SIR_poisson, cache = TRUE}
source("./stan_utils.R")
# y is now discrete
stan_data_poisson <- "
data {
  int<lower = 1> n_obs; // Number of weeks sampled
  int<lower = 1> n_params; // Number of model parameters
  int<lower = 1> n_difeq; // Number of differential equations in the system
  int y[n_obs]; 
  real t0; // Initial time point (zero)
  real ts[n_obs]; // Time points that were sampled
}
"

stan_parameters_poisson <- "
parameters {
  real<lower = 0> params[n_params]; // Model parameters
}
"

func_params   <- list(recovery_delay = 0.5)
stan_function <- generate_stan_function("SIR", func_params)
initStocks    <- list(Susceptible = 990, Infected = 10, Recovered = 0)
stan_td       <- generate_transformed_data_block()
stan_tp       <- generate_transformed_parameters("SIR", initStocks)
stan_model    <- generate_stan_model(likelihood = "poisson",
                                  n_params = 1)

stan_text <- paste(stan_function, stan_data_poisson, stan_td, 
                   stan_parameters_poisson, stan_tp, stan_model, sep = "\n")

create_stan_file(stan_text, "SIR_1_par.stan")

stan_fit <- fit_stan_model(
  stan_file = "SIR_1_par.stan", n_constants = 1, synthetic_incidence, 
  warm_up = 2000, iterations = 4000, seed = 466899087, n_difeq = 3)
```

```{r g_th_oneParam_SIR_poisson, cache = TRUE}
source('./graphs.R')
posterior_df <- as.data.frame(stan_fit)
specs_list <- list(x_pos = 1.0255, ypos_mean = 35, ypos_median = 32, 
                   text_size = 2, ypos_interval = 28, 
                   title = "Incidence fit - Poisson", xlabel = "")

g2 <- draw_density(posterior_df$`params[1]`, specs_list)
```

```{r}
ggsave("./plots/g_ec_normal_111.png", g1, dpi = "print", height = 5, width = 8)
```

```{r, cache = TRUE}
model_file       <- "./deterministic_models/SIR_cumulative.stmx"
mdl              <- read_xmile(model_file)
stan_fun         <- create_stan_function(model_file, "SIR_cum", pars = "ec")
stan_td          <- generate_transformed_data_block()
counter          <- 0

stan_d <- list(n_obs   = length(synthetic_cum_inc),
              n_params = 1, 
              n_difeq  = 4, # number of differential equations
              y        = synthetic_cum_inc,
              t0       = 0,
              ts       = 1:length(synthetic_cum_inc))
```

```{r, cache = TRUE}
stan_data   <- generate_data_block("normal")
stan_params <- generate_parameters_block("normal")

stan_model_text <- c(
  "  params[1] ~ uniform(0, 500)",
  "  sigma     ~ cauchy( 0 , 2 )",
  "  y         ~ normal(cum_inc, sigma)"
)

stan_model  <- generate_model_text(stan_model_text)
stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp_cum, stan_model, sep = "\n")

filename <- "SIR_1.1.1.2_normal.stan"
create_stan_file(stan_text, filename)

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
             verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
fit_1.1.1.2_normal <- stan(
  fit = test, data = stan_d, chains = 3, warmup = 2000, iter   = 4000, 
  cores  = 3, seed = 1250266639, refresh = 5)
```

```{r}
source('./graphs.R')
posterior_df <- as.data.frame(fit_1.1.1.2_normal)
specs_list <- list(x_pos = 1.0003, ypos_mean = 3000, ypos_median = 2500, 
                   text_size = 2, ypos_interval = 2000, 
                   title = "Cumulative fitting - Normal", xlabel = "")

g3 <- draw_density(posterior_df$`params[1]`, specs_list)
```



```{r fit_1_param_poisson_cml, cache = TRUE}
source('./stan_utils.R')

stan_data        <- generate_data_block("poisson")
stan_params      <- generate_parameters_block("poisson")

stan_model_text <- c(
  "  params[1] ~ uniform(0, 500)",
  "  y         ~ poisson(cum_inc)"
)

stan_model  <- generate_model_text(stan_model_text)

stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp_cum, stan_model, sep = "\n")

filename <- "SIR_1.1.1.2_poisson.stan"
create_stan_file(stan_text, filename)

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
             verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
fit_1.1.1.2_poisson <- stan(fit = test, data = stan_d, chains = 3, warmup = 1000,
                         iter   = 2000, cores  = 3, seed = 1250266639, refresh = 5)
```

```{r}
g4 <- stan_trace(fit_1.1.1.2_poisson, pars = "params[1]") +
  labs(title = "Cumulative fitting - Poisson") +
  theme(plot.title = element_text(color = "#404040", size = 8))
```


```{r g_th_oneParam_SIR, fig.height = 5}
grid.arrange(g1, g2, g3, g4, nrow = 2, ncol = 2)
```

\newpage

### 1.1.2 Fitting two parameters

#### 1.1.2.1 Effective contacts & recovery delay

##### 1.1.2.1.1 Normal likelihood

```{r th_SIR_normal_two_params, cache = TRUE}
source('./stan_utils.R')

stan_fun     <- generate_stan_function("SIR")
stan_data    <- generate_data_block("normal")
stan_td      <- generate_transformed_data_block()
stan_params  <- generate_parameters_block("normal")
initStocks   <- list(Susceptible = 990, Infected = 10, Recovered = 0)
stan_tp      <- generate_transformed_parameters("SIR", initStocks)
normal_model <- c("params[1] ~ uniform(0, 500)", "params[2] ~ uniform(0, 20)",
                "sigma ~ cauchy( 0 , 2 )", "y ~ normal(incidence, sigma)")
stan_model   <- generate_model_text(normal_model)

stan_text <- paste(stan_fun, stan_data, stan_td, stan_params,stan_tp, 
                   stan_model, sep = "\n")

create_stan_file(stan_text, "SIR.stan")
```


###### 1.1.2.1.1.1 Right model (SIR fitting SIR incidence)

\hfill\break

```{r th_SIR_normal_two_params_right, cache = TRUE}
sf_normal_right <- fit_stan_model(
  n_constants = 2, synthetic_incidence, warm_up = 2000, iterations = 4000,
  seed = 39843593, n_difeq = 3)
```

```{r p_th_SIR_normal_two_params_right, fig.width = 9, fig.height = 4}
g <- mcmc_pairs(sf_normal_right, pars = c("params[1]", "params[2]", "sigma"))
print(g)
```
\hfill\break

```{r g_th_SIR_normal_two_params_right, cache = TRUE, fig.height = 4}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"),
                    list(new = "recoveryProportion", old = "params[2]"))

graph_inputs <- generate_graph_inputs(
  stan_fit = sf_normal_right,
  pars = c("effective_contacts", "recoveryTime"),
  rename_pars = rename_pars,
  x_pos          = c(1.004, 2.023),
  y_pos          = c(200, 56),
  y_pos_median   = c(185, 52),
  y_pos_interval = c(165, 46))

g <- draw_multiple_densities(graph_inputs$densities, graph_inputs$stats_df,
                             text_size = 2) +
  labs(title = "Fitting incidence rate")
print(g)
```
\newpage

```{r two_params_SIR_cumulative, cache = TRUE}
source('./stan_utils.R')

model_file       <- "./deterministic_models/SIR_cumulative.stmx"
mdl              <- read_xmile(model_file)
stan_fun         <- create_stan_function(model_file, "SIR_cum", 
                                         pars = c("ec", "recovery_proportion"))
stan_data    <- generate_data_block("normal")
stan_td      <- generate_transformed_data_block()
stan_params  <- generate_parameters_block("normal")

normal_model <- c("params[1] ~ uniform(0, 500)", "params[2] ~ uniform(0, 20)",
                  "sigma ~ cauchy( 0 , 2 )", "y ~ normal(cum_inc, sigma)")
stan_model   <- generate_model_text(normal_model)

stan_text <- paste(stan_fun, stan_data, stan_td, stan_params, stan_tp_cum,
                   stan_model, sep = "\n")

filename <- "SIR_1.1.2.1.1.1_cum.stan"
create_stan_file(stan_text, filename)

stan_d <- list(n_obs    = length(synthetic_cum_inc),
              n_params = 2, 
              n_difeq  = 4, # number of differential equations
              y        = synthetic_cum_inc,
              t0       = 0,
              ts       = 1:length(synthetic_cum_inc))

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
             verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
fit_1.1.2.1.1.1_cum <- stan(
  fit = test, data = stan_d, chains = 3, warmup = 2000, iter   = 4000, 
  cores  = 3, seed = 1250266639, refresh = 5)
```

```{r p_two_params_SIR_cumulative, fig.width = 9, fig.height = 4}
g <- mcmc_pairs(fit_1.1.2.1.1.1_cum, pars = c("params[1]", "params[2]", "sigma"))
print(g)
```

```{r g_two_params_SIR_cumulative, fig.height = 4}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"),
                    list(new = "recoveryProportion", old = "params[2]"))

graph_inputs <- generate_graph_inputs(
  stan_fit = fit_1.1.2.1.1.1_cum,
  pars = c("effective_contacts", "recoveryTime"),
  rename_pars = rename_pars,
  x_pos          = c(1.0007, 2.0015),
  y_pos          = c(1300, 500),
  y_pos_median   = c(1200, 480),
  y_pos_interval = c(1100, 460))

g <- draw_multiple_densities(graph_inputs$densities, graph_inputs$stats_df,
                             text_size = 2) +
  labs(title = "Fitting cumulative incidence")
print(g)
```


###### 1.1.2.1.1.2 Wrong model (SIR fitting SEIR incidence)

```{r th_SIR_normal_two_params_wrong, cache = TRUE}
source('./stan_utils.R')

stan_fit_normal_wrong <- fit_stan_model(
  n_constants = 2, synthetic_incidence2, warm_up = 2000, iterations = 4000,
  seed = 1407382414, n_difeq = 3)
pairs(stan_fit_normal_wrong, pars = c("params[1]", "params[2]", "sigma"))
```

```{r g_th_SIR_normal_two_params_wrong, cache = TRUE}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"),
                    list(new = "recoveryProportion", old = "params[2]"))

graph_inputs <- generate_graph_inputs(
  stan_fit = stan_fit_normal_wrong,
  pars = c("effective_contacts", "recoveryTime"),
  rename_pars = rename_pars,
  x_pos = c(0.535, 4.6), 
  y_pos = c(50, 2.6),
  y_pos_median = c(48, 2.4), 
  y_pos_interval = c(45, 2.2))

g <- draw_multiple_densities(graph_inputs$densities, graph_inputs$stats_df,
                             text_size = 2)
print(g)
```

\newpage
##### 1.1.2.1.2 Poisson likelihood

```{r th_SIR_poisson_two_params, cache = TRUE}
source("./stan_utils.R")

stan_fun    <- generate_stan_function("SIR")
stan_data   <- generate_data_block("poisson")
stan_td     <- generate_transformed_data_block()
stan_params <- generate_parameters_block("poisson")
initStocks  <- list(Susceptible = 990, Infected = 10, Recovered = 0)
stan_tp     <- generate_transformed_parameters("SIR", initStocks)
stan_model  <- generate_stan_model(likelihood = "poisson",
                                  n_params = 2)
stan_text <- paste(stan_fun, stan_data, stan_td, stan_params,
                    stan_tp, stan_model, sep = "\n")

create_stan_file(stan_text, "SIR_poisson.stan")
```

###### 1.1.2.1.2.1 Right model (SIR fitting SIR incidence)

```{r th_SIR_poisson_two_params_right, cache = TRUE}
source("./stan_utils.R")

stan_fit_poisson_right <- fit_stan_model(
  stan_file = 'SIR_poisson.stan', n_constants = 2, synthetic_incidence, 
  warm_up = 2000, iterations = 4000, seed = 245391088, n_difeq = 3)

pairs(stan_fit_poisson_right, pars = c("params[1]", "params[2]"))
```

```{r g_th_SIR_poisson_two_params_right, cache = TRUE}
source("./graphs.R")
library(rethinking)
# Parameters posterior
posterior_df <- as.data.frame(stan_fit_poisson_right) %>% 
  rename(effective_contacts = 'params[1]',
         recoveryProportion = 'params[2]') %>% 
  mutate(recoveryTime = 1 / recoveryProportion)

params_df<- posterior_df %>% 
  select(effective_contacts, recoveryTime)

credible_intervals <- apply(params_df, 2, HPDI, prob = 0.95) %>% t() %>% 
  as.data.frame() %>% 
  rename(lower_interval = "|0.95", upper_interval = "0.95|") %>% 
  mutate(param = rownames(.))

means   <- apply(params_df, 2, mean)
medians <- apply(params_df, 2, median)

stats_df <- data.frame(stringsAsFactors = FALSE,
                       param = names(means), 
                       mean_value = means,
                       median_value = medians,
                       lower_interval = credible_intervals$lower_interval,
                       upper_interval = credible_intervals$upper_interval) %>% 
  mutate(mean_label     = paste0("mean   = ", round(mean_value, 3)),
         median_label   = paste0("median = ", round(median_value, 3)),
         interval_label = paste0("[ ", round(lower_interval, 3), ", ", 
                                 round(upper_interval, 3), " ]"),
         x_pos          = c(1.09, 2.45),
         y_pos_mean     = c(11, 2.25),
         y_pos_median   = c(10, 2.10),
         y_pos_interval = c(8.6, 1.90))

densities <- apply(params_df, 2, density) %>% lapply(function(densityObj){
    data.frame(x = densityObj$x, y = densityObj$y)
  }) %>% bind_rows(.id = "param") %>% 
  inner_join(credible_intervals) %>% 
  mutate(area = x >= lower_interval & x <= upper_interval)

g <- draw_multiple_densities(densities, stats_df, text_size = 4)

print(g)

```

\newpage
###### 1.1.2.1.2.2 Wrong model (SIR fitting SEIR incidence)

```{r th_SIR_poisson_two_params_wrong, cache = TRUE}
source("./stan_utils.R")

stan_fit_poisson_wrong <- fit_stan_model(
  stan_file = 'SIR_poisson.stan', n_constants = 2, synthetic_incidence2, 
  warm_up = 2000, iterations = 4000, seed = 1926466221, n_difeq = 3)

pairs(stan_fit_poisson_wrong, pars = c("params[1]", "params[2]"))
```

```{r g_th_SIR_poisson_two_params_wrong, cache = TRUE}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"),
                    list(new = "recoveryProportion", old = "params[2]"))

graph_inputs <- generate_graph_inputs(
  stan_fit = stan_fit_poisson_wrong,
  pars = c("effective_contacts", "recoveryTime"),
  rename_pars = rename_pars,
  x_pos = c(0.56, 4.8), 
  y_pos = c(20, 0.8),
  y_pos_median = c(19, 0.75), 
  y_pos_interval = c(18, 0.7))

g <- draw_multiple_densities(graph_inputs$densities, graph_inputs$stats_df,
                             text_size = 2)
print(g)
```

\newpage
#### 1.1.2.2 Effective contacts & S0

##### 1.1.2.2.1 Normal likelihood

```{r th_SIR_normal_two_params2}
source('./stan_utils.R')

func_params  <-list(recovery_delay = 0.5)
stan_fun     <-generate_stan_function("SIR", func_params)
stan_data    <- generate_data_block("normal")
stan_td      <- generate_transformed_data_block()
stan_params  <- generate_parameters_block("normal", stocks = "S0")
initStocks   <- list(Susceptible = "S0", Infected = 10, Recovered = 0)
stan_tp      <- generate_transformed_parameters("SIR", initStocks)
normal_model <- c("params[1] ~ uniform(0, 500)", "S0 ~ normal(0, 1000000)",
                "sigma ~ cauchy( 0 , 2 )", "y ~ normal(incidence, sigma)")
stan_model   <- generate_model_text(normal_model)

stan_text <- paste(stan_fun, stan_data, stan_td, stan_params,stan_tp, 
                   stan_model, sep = "\n")

create_stan_file(stan_text, "SIR.stan")
```

###### 1.1.2.2.1.1 Right model (SIR fitting SIR incidence)
```{r th_SIR_normal_two_params_right2, cache = TRUE, fig.height = 4}
stan_fit_normal_right2 <- fit_stan_model(
  n_constants = 1, synthetic_incidence, warm_up = 2000, iterations = 4000,
  seed = 1694212849, n_difeq = 3)

pairs(stan_fit_normal_right2, pars = c("params[1]", "S0", "sigma"))
```

```{r g_th_SIR_normal_two_params_right2, cache = TRUE, fig.height = 4}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"))

graph_inputs <- generate_graph_inputs(
  stan_fit_normal_right2, pars = c("effective_contacts", "S0"),
  rename_pars = rename_pars,
  x_pos = c(1.0005, 994), 
  y_pos = c(700, 0.3),
  y_pos_median = c(650, 0.28), 
  y_pos_interval = c(600, 0.26))

g <- draw_multiple_densities(graph_inputs$densities, graph_inputs$stats_df,
                             text_size = 2)
print(g)
```

\newpage

###### 1.1.2.2.1.2 Wrong model (SIR fitting SEIR incidence)

```{r th_SIR_normal_two_params_wrong2, cache = TRUE}
stan_fit_normal_wrong2 <- fit_stan_model(
  n_constants = 1, synthetic_incidence2, warm_up = 2000, iterations = 4000,
  seed = 779238554, n_difeq = 3)

pairs(stan_fit_normal_wrong2, pars = c("params[1]", "S0", "sigma"))
```

```{r g_th_SIR_normal_two_params_wrong2, cache = TRUE}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"))

graph_inputs <- generate_graph_inputs(
  stan_fit_normal_wrong2, pars = c("effective_contacts", "S0"),
  rename_pars = rename_pars,
  x_pos = c(0.76, 1550), 
  y_pos = c(90, 0.012),
  y_pos_median = c(85, 0.011), 
  y_pos_interval = c(80, 0.010))

g <- draw_multiple_densities(graph_inputs$densities, graph_inputs$stats_df,
                             text_size = 2)
print(g)
```

\newpage
##### 1.1.2.2.2 Poisson distribution

```{r th_SIR_poisson_two_params2}
source("./stan_utils.R")

func_params <-list(recovery_delay = 0.5)
stan_fun    <-generate_stan_function("SIR", func_params)
stan_data   <- generate_data_block("poisson")
stan_td     <- generate_transformed_data_block()
stan_params <- generate_parameters_block("poisson", stocks = "S0")
initStocks  <- list(Susceptible = "S0", Infected = 10, Recovered = 0)
stan_tp     <- generate_transformed_parameters("SIR", initStocks)
stat_model  <- c("params[1] ~ uniform(0, 500)", "S0 ~ normal(0, 100000)",
                 "y ~ poisson(incidence)")
stan_model  <- generate_model_text(stat_model)
stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp, stan_model, sep = "\n")

create_stan_file(stan_text, "SIR_poisson.stan")
```

###### 1.1.2.2.2.1 Right model (SIR fitting SIR incidence)

```{r th_SIR_poisson_two_params_right2, cache = TRUE}
source("./stan_utils.R")

stan_fit_poisson_right2 <- fit_stan_model(
  stan_file = 'SIR_poisson.stan', n_constants = 1, synthetic_incidence, 
  warm_up = 2000, iterations = 4000, seed = 1682200822, n_difeq = 3)

pairs(stan_fit_poisson_right2, pars = c("params[1]", "S0"))
```

```{r g_th_SIR_poisson_two_params_right2, cache = TRUE}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"))

graph_inputs <- generate_graph_inputs(
  stan_fit_poisson_right2, pars = c("effective_contacts", "S0"),
  rename_pars = rename_pars,
  x_pos = c(1.02, 1060), 
  y_pos = c(30, 0.011),
  y_pos_median = c(28, 0.01), 
  y_pos_interval = c(26, 0.009))

g <- draw_multiple_densities(graph_inputs$densities, graph_inputs$stats_df,
                             text_size = 2)
print(g)
```

\newpage

###### 1.1.2.2.2.2 Wrong model (SIR fitting SEIR incidence)

```{r th_SIR_poisson_two_params_wrong2, cache = TRUE}
source("./stan_utils.R")

sf_poisson_wrong2 <- fit_stan_model(
  stan_file = 'SIR_poisson.stan', n_constants = 1, synthetic_incidence2, 
  warm_up = 2000, iterations = 4000, seed = 591867144, n_difeq = 3)

pairs(sf_poisson_wrong2, pars = c("params[1]", "S0"))
```

```{r g_th_SIR_poisson_two_params_wrong2, cache = TRUE}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"))

graph_inputs <- generate_graph_inputs(
  sf_poisson_wrong2, pars = c("effective_contacts", "S0"),
  rename_pars = rename_pars,
  x_pos = c(0.767, 1490), 
  y_pos = c(54, 0.008),
  y_pos_median = c(51, 0.0075), 
  y_pos_interval = c(48, 0.007))

g <- draw_multiple_densities(graph_inputs$densities, graph_inputs$stats_df,
                             text_size = 2)
print(g)
```

\newpage

#### 1.1.2.3 Calibration

```{r g_th_SIR_two_params, cache = TRUE}

produce_SIR_fit <- function(fit, label) {
  posterior_df <- as.data.frame(fit) %>%
    rename(effective_contacts = 'params[1]',
           recoveryProportion = 'params[2]') %>% 
    mutate(recoveryTime = 1 / recoveryProportion)
  
  SIR_obj <- SIR(
  initInfected = 10,
  effectiveContacts = mean(posterior_df$effective_contacts), 
  recoveryTime = mean(posterior_df$recoveryTime))
  
  SIR_obj$incidence_data %>% mutate(model = label)
}

labels   <- c("fit_normal_SIR", "fit_poisson_SIR")
fits     <- c(sf_normal_right, stan_fit_poisson_right)

fitted_df <- map2_df(fits, labels, produce_SIR_fit)
df        <- bind_rows(SIR_df, fitted_df)

g1 <- ggplot(df, aes(x = time, y = incidence, group = model)) +
  geom_line(aes(colour = model), alpha = 0.5) +
  scale_color_manual(values = c("darkgreen", "blue", "grey")) +
  scale_y_continuous(limits = c(0,100)) +
  theme_test() +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 5)) 

labels   <- c("fit_normal_SIR", "fit_poisson_SIR")
fits     <- c(stan_fit_normal_wrong, stan_fit_poisson_wrong)

fitted_df <- map2_df(fits, labels, produce_SIR_fit)
df        <- bind_rows(SEIR_df, fitted_df)

g2 <- ggplot(df, aes(x = time, y = incidence, group = model)) +
  geom_line(aes(colour = model), alpha = 0.5) +
  scale_color_manual(values = c("darkgreen", "blue", "grey")) +
  scale_y_continuous(limits = c(0,100)) +
  theme_test() +
  theme(legend.position = "bottom", 
        legend.text = element_text(size = 5))

grid.arrange(g1, g2, nrow = 1, top = "Fitting effective contacts & recovery delay")
```

```{r g_th_SIR_two_params2, cache = TRUE}

produce_SIR_fit <- function(fit, label) {
  posterior_df <- as.data.frame(fit) %>%
    rename(effective_contacts = 'params[1]')
  
  SIR_obj <- SIR(
  initInfected = 10,
  initSusceptible = mean(posterior_df$S0),
  effectiveContacts = mean(posterior_df$effective_contacts), 
  recoveryTime = 2)
  
  SIR_obj$incidence_data %>% mutate(model = label)
}

labels   <- c("fit_normal_SIR", "fit_poisson_SIR")
fits     <- c(stan_fit_normal_right2, stan_fit_poisson_right2)

fitted_df <- map2_df(fits, labels, produce_SIR_fit)
df        <- bind_rows(SIR_df, fitted_df)

g1 <- ggplot(df, aes(x = time, y = incidence, group = model)) +
  geom_line(aes(colour = model), alpha = 0.5) +
  scale_color_manual(values = c("darkgreen", "blue", "grey")) +
  scale_y_continuous(limits = c(0,100)) +
  theme_test() +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 5)) 
#-------------------------------------------------------------------------------

labels   <- c("fit_normal_SIR", "fit_poisson_SIR")
fits     <- c(stan_fit_normal_wrong2, sf_poisson_wrong2)

fitted_df <- map2_df(fits, labels, produce_SIR_fit)
df        <- bind_rows(SEIR_df, fitted_df)

g2 <- ggplot(df, aes(x = time, y = incidence, group = model)) +
  geom_line(aes(colour = model), alpha = 0.5) +
  scale_color_manual(values = c("darkgreen", "blue", "grey")) +
  scale_y_continuous(limits = c(0,100)) +
  theme_test() +
  theme(legend.position = "bottom", 
        legend.text = element_text(size = 5))

grid.arrange(g1, g2, nrow = 1, top = "Fitting effective contacts & S0")
```



### 1.1.3 Fitting three parameters (Effective contacts, recovery delay & S0)

```{r susceptible_priors, cache = TRUE}
sus_priors <- c(
  "S0 ~ normal(990, 1);",
  "S0 ~ normal(791, 10);",
  "S0 ~ normal(791, 250);")
```


#### 1.1.3.1 Fitting one dataset (Incidence data)

##### 1.1.3.1.1 Normal distribution

```{r th_SIR_normal_three_params, cache = TRUE}
source('./stan_utils.R')

# stan parameters normal init value. Adds S0
stan_pn_init_value <- "
parameters {
  real<lower = 0> params[n_params]; // Model parameters
  real<lower = 0> sigma;
  real<lower = 0> S0; // Initial number of susceptibles
}
"
# S0 is now an unknown value
stan_transformed_parameters <- "
transformed parameters{
  real y_hat[n_obs, n_difeq]; // Output from the ODE solver
  real y0[n_difeq]; // Initial conditions
  real incidence[n_obs];
    
  y0[1] = S0;
  y0[2] = 10;
  y0[3] = 0;
  
  y_hat = integrate_ode_rk45(SIR, y0, t0, ts, params, x_r, x_i);
  
  incidence[1] =  y_hat[1, 2] + y_hat[1, 3];
  
  for (i in 1:n_obs-1) {
    incidence[i + 1] = y_hat[i + 1, 2] + y_hat[i + 1, 3] - y_hat[i, 2] - y_hat[i, 3] + 0.00001; 
  }
  
}
"

stan_fun  <- generate_stan_function("SIR")
stan_data <- generate_data_block("normal")
stan_td   <- generate_transformed_data_block()

stan_fits_normal <- vector(mode = "list", length = length(sus_priors))

for(i in seq_len(length(sus_priors))) {
  
  susceptible_prior <- sus_priors[i]
  
  stan_model <- generate_stan_model(susceptible_prior, likelihood = "normal",
                                    n_params = 3)
  
  stan_text <- paste0(stan_fun, stan_data, stan_td, stan_pn_init_value, 
                      stan_transformed_parameters, stan_model)
  
  create_stan_file(stan_text, "SIR.stan")
  
  stan_fit <- fit_stan_model(n_constants = 2, synthetic_incidence,
                             warm_up = 2000, iterations = 4000, 
                             seed = 1000000)
  stan_fits_normal[i] <- stan_fit
}
```


###### 1.1.3.1.1.1 Prior: S0 ~ Normal(990, 1)

```{r g1_th_SIR_normal_three_params, fig.height = 4}
source('./graphs.R')

pairs(stan_fits_normal[[1]], pars = c("params[1]", "params[2]", "S0", "sigma"))
```

```{r tp_th_SIR_normal_three_params, fig.height = 4}
stan_trace(stan_fits_normal[[1]], pars = c("params[1]", "params[2]", "S0", "sigma"))
```


###### 1.1.3.1.1.2 Prior: S0 ~ Normal(791, 10)

```{r p2_th_SIR_normal_three_params}
pairs(stan_fits_normal[[2]], pars = c("params[1]", "params[2]", "S0", "sigma"))
```

```{r g2_th_SIR_normal_three_params}

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"),
                    list(new = "recoveryProportion", old = "params[2]"))


graph_inputs <- generate_graph_inputs(
  stan_fit = stan_fits_normal[[2]],
  pars = c("effective_contacts", "recoveryTime", "S0"),
  rename_pars = rename_pars,
  x_pos = c(0.83, 4.75, 830),
  y_pos = c(20, 1.2, 0.035),
  y_pos_median = c(19, 1.15, 0.0335),
  y_pos_interval = c(17, 1.05, 0.0305))


g <- draw_multiple_densities(graph_inputs$densities,
                             graph_inputs$stats_df,
                             text_size = 2)

g <- g + labs(title = "Prior: normal(791, 10)")
print(g)
```

\newpage
###### 1.1.3.1.1.3 Prior: S0 ~ Normal(791, 250)

```{r p3_th_SIR_normal_three_params}
pairs(stan_fits_normal[[3]], pars = c("params[1]", "params[2]", "S0", "sigma"))
```

```{r g3_th_SIR_normal_three_params}

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"),
                    list(new = "recoveryProportion", old = "params[2]"))

graph_inputs <- generate_graph_inputs(
  stan_fit = stan_fits_normal[[3]],
  pars = c("effective_contacts", "recoveryTime", "S0"),
  rename_pars = rename_pars,
  x_pos = c(1.04, 3,1020),
  y_pos = c(10, 1.2, 0.01),
  y_pos_median = c(9.6, 1.15, 0.0095),
  y_pos_interval = c(8.9, 1.08, 0.0087))


g <- draw_multiple_densities(graph_inputs$densities,
                             graph_inputs$stats_df,
                             text_size = 2)

g <- g + labs(title = "Prior: normal (791,250)")
print(g)
```

```{r fit_cml_3_params_SIR, cache=TRUE}

model_file       <- "./deterministic_models/SIR_cumulative.stmx"
mdl              <- read_xmile(model_file)
stan_fun         <- create_stan_function(model_file, "SIR_cum", 
                                         pars = c("ec", "recovery_proportion"))
stan_data    <- generate_data_block("normal")
stan_td      <- generate_transformed_data_block()
stan_params  <- generate_parameters_block("normal", "S0")

normal_model <- c(
  "params[1] ~ uniform(0, 500)", "params[2] ~ uniform(0, 20)", 
  "S0 ~ normal(790, 250)", "sigma ~ cauchy( 0 , 2 )", 
  "y ~ normal(cum_inc, sigma)")
stan_model   <- generate_model_text(normal_model)

stan_text <- paste(stan_fun, stan_data, stan_td, stan_params, 
                   stan_tp_SIR_cml_S0,
                   stan_model, sep = "\n")

filename <- "SIR_1.1.3.1.1.3_cum.stan"
create_stan_file(stan_text, filename)

stan_d <- list(n_obs    = length(synthetic_cum_inc),
              n_params = 2, 
              n_difeq  = 4, # number of differential equations
              y        = synthetic_cum_inc,
              t0       = 0,
              ts       = 1:length(synthetic_cum_inc))

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
             verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
fit_1.1.3.1.1.3_cum <- stan(
  fit = test, data = stan_d, chains = 3, warmup = 2000, iter   = 4000, 
  cores  = 3, seed = 950997367, refresh = 5)
```

```{r}
pairs(fit_1.1.3.1.1.3_cum, pars = c("params[1]", "params[2]", "S0", "sigma"),
      main = "Cumulative fitting")
```

\newpage

##### 1.1.3.1.2 Poisson distribution

```{r th_SIR_poisson_three_params, cache = TRUE}
source('./stan_utils.R')

stan_fun    <- generate_stan_function("SIR")
stan_data   <- generate_data_block("poisson")
stan_td     <- generate_transformed_data_block()
# stan parameters Poisson init value. Adds S0
stan_pp_init_value <- "
parameters {
  real<lower = 0> params[n_params]; // Model parameters
  real<lower = 0> S0; // Initial number of susceptibles
}
"

initStocks  <- list(Susceptible = "S0", Infected = 10, Recovered = 0)
stan_tp     <- generate_transformed_parameters("SIR", initStocks)

stan_fits_poisson <- vector(mode = "list", length = length(sus_priors))

for(i in seq_len(length(sus_priors))) {
  
  susceptible_prior <- sus_priors[i]
  
  stan_model <- generate_stan_model(susceptible_prior,
                                    likelihood = "poisson",
                                    n_params = 3)
  
  stan_text <- paste0(stan_fun, stan_data, stan_td , stan_pp_init_value, 
                      stan_tp, stan_model)
  
  create_stan_file(stan_text, "SIR.stan")
  
  stan_fit <- fit_stan_model(n_constants = 2, synthetic_incidence,
                             warm_up = 2000, 
                             iterations = 8000, 
                             seed = 1168103287,
                             n_difeq = 3)
  stan_fits_poisson[i] <- stan_fit
}
```

###### 1.1.3.1.2.1 Prior: S0 ~ Normal(990, 1)
```{r p1_th_SIR_poisson_three_params}
pairs(stan_fits_poisson[[1]], pars = c("params[1]", "params[2]", "S0"))
```


```{r g1_th_SIR_poisson_three_params}
# source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"),
                    list(new = "recoveryProportion", old = "params[2]"))

graph_inputs <- generate_graph_inputs(
  stan_fit = stan_fits_poisson[[1]],
  pars = c("effective_contacts", "recoveryTime", "S0"),
  rename_pars = rename_pars,
  x_pos = c(1.07, 2.4, 993),
  y_pos = c(10, 2.2, 0.35),
  y_pos_median = c(9.5, 2.1, 0.335),
  y_pos_interval = c(9, 2.0, 0.305))


g <- draw_multiple_densities(graph_inputs$densities,
                             graph_inputs$stats_df,
                             text_size = 2)

g <- g + labs(title = "Prior: normal (990,1)")
print(g)

```

###### 1.1.3.1.2.2 Prior: S0 ~ Normal(790, 10)

```{r p2_th_SIR_poisson_three_params}
  pairs(stan_fits_poisson[[2]], pars = c("params[1]", "params[2]", "S0"))
```


```{r g2_th_SIR_poisson_three_params}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"),
                    list(new = "recoveryProportion", old = "params[2]"))

graph_inputs <- generate_graph_inputs(
  stan_fit = stan_fits_poisson[[2]],
  pars = c("effective_contacts", "recoveryTime", "S0"),
  rename_pars = rename_pars,
  x_pos = c(0.87, 5.5, 820),
  y_pos = c(10, 0.6, 0.035),
  y_pos_median = c(9.5, 0.55, 0.0335),
  y_pos_interval = c(9, 0.5, 0.0305))


g <- draw_multiple_densities(graph_inputs$densities, 
                             graph_inputs$stats_df,
                             text_size = 2)

g <- g + labs(title = "Prior: normal (791, 10)")
print(g)

```

\newpage
###### 1.1.3.1.2.3 Prior: S0 ~ Normal(790, 250)

```{r p3_th_SIR_poisson_three_params}
pairs(stan_fits_poisson[[3]], pars = c("params[1]", "params[2]", "S0"))
```

```{r g3_th_SIR_poisson_three_params}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"),
                    list(new = "recoveryProportion", old = "params[2]"))
graph_inputs <- generate_graph_inputs(
  stan_fit = stan_fits_poisson[[3]],
  pars = c("effective_contacts", "recoveryTime", "S0"),
  rename_pars = rename_pars,
  x_pos = c(1.26, 3.5, 1280),
  y_pos = c(3, 0.8, 0.003),
  y_pos_median = c(2.8, 0.75, 0.0028),
  y_pos_interval = c(2.5, 0.68, 0.0026))


g <- draw_multiple_densities(graph_inputs$densities, 
                             graph_inputs$stats_df,
                             text_size = 2)

g <- g + labs(title = "Prior: normal(791, 250)")
print(g)

```

\newpage

##### 1.1.3.1.3 Calibration

```{r th_3_params_calibration}

get_sim_dfs <- function(fit, label) {
  posterior_df <- as.data.frame(fit) %>%
    rename(effective_contacts = 'params[1]',
           recoveryProportion = 'params[2]') %>%
    mutate(recoveryTime = 1 / recoveryProportion)

  SIR_obj <- SIR(
  initInfected = 10,
  effectiveContacts = mean(posterior_df$effective_contacts),
  recoveryTime = mean(posterior_df$recoveryTime),
  initSusceptible = mean(posterior_df$S0))
  
  recovery_df <- generate_recovery_df(SIR_obj) %>% 
    mutate(model = label)
  
  list(incidence_df = SIR_obj$incidence_data %>% mutate(model = label),
       recovery_df  = recovery_df)
}

sf_normal <- stan_fits_normal
sf_normal[[1]] <- NULL
sf_poisson <- stan_fits_poisson

labels_normal <- c("Normal (790,10)", "Normal (790, 250)")
labels_poisson <- c("Normal (990, 1)", labels_normal) 

sim_dfs_normal      <- map2(sf_normal, labels_normal, get_sim_dfs) 

incidence_df_normal <- map_df(sim_dfs_normal, "incidence_df") %>%
  rename(value = incidence) %>% 
  mutate(likelihood = "normal", var = "incidence")

R_data <- generate_recovery_df(SIR_output) %>% 
  mutate(model = "actual data", var = "recovery") %>% 
  rename(value = recovery)

recovery_df_normal  <- map_df(sim_dfs_normal, "recovery_df") %>%
  rename(value = recovery) %>% 
  mutate(likelihood = "normal", var = "recovery")

sim_dfs_poisson      <- map2(sf_poisson, labels_poisson, get_sim_dfs)

incidence_df_poisson <- map_df(sim_dfs_poisson , "incidence_df") %>%
  rename(value = incidence) %>%
  mutate(likelihood = "poisson", var = "incidence")

recovery_df_poisson  <- map_df(sim_dfs_poisson, "recovery_df") %>%
  rename(value = recovery) %>%
  mutate(likelihood = "poisson", var = "recovery")

comparison_df <- bind_rows(incidence_df_normal, recovery_df_normal,
                           incidence_df_poisson, recovery_df_poisson) %>% 
  mutate(model_likelihood = paste(model, likelihood, sep = "-"))

inc_data <- SIR_df %>% mutate(model = "actual data", var = "incidence") %>% 
  rename(value = incidence)

actual_data_df <- bind_rows(R_data, inc_data) %>% select(-model)


ggplot(comparison_df, aes(x = time, y = value)) +
  geom_line(aes(group = model_likelihood, colour = likelihood), alpha = 0.5) +
  # scale_colour_manual(values = c("#ca0020", "#f4a582", "#404040","#bababa")) +
  facet_grid(vars(var), vars(model)) +
  geom_line(data = actual_data_df, aes(x = time, y = value), colour = "grey") +
  theme_test()

```

\newpage
#### 1.1.3.2 Fitting two datasets (Incidence data & recovery data)

```{r incidence_recovery_graphs, cache = TRUE}
R_data <- generate_recovery_df(SIR_output)

df_incidence <- SIR_df %>% rename(value = incidence, var = model) %>% 
  mutate(var = "incidence")
df_recovery  <- R_data %>% rename(value = recovery) %>% 
  mutate(var = "recovery")

df_rates <- bind_rows(df_incidence, df_recovery)

ggplot(df_rates, aes(x = time, y = value)) +
  geom_line() +
  facet_wrap(~var, ncol = 1) +
  theme_test()
```


```{r th_SIR_poisson_three_params_two_datasets, cache = TRUE}
source('./stan_utils.R')
stan_fun    <- generate_stan_function("SIR")

stan_data   <- paste(
  "data {",
  "  int<lower = 1> n_obs; // Number of weeks sampled",
  "  int<lower = 1> n_params; // Number of model parameters",
  "  int<lower = 1> n_difeq; // Number of differential equations in the system",
  "  int y[n_obs];",
  "  int y2[n_obs];",
  "  real t0; // Initial time point (zero)",
  "  real ts[n_obs]; // Time points that were sampled",
  "}", sep = "\n")

stan_td     <- generate_transformed_data_block()
# stan parameters Poisson init value. Adds S0
stan_par    <- generate_parameters_block("poisson", "S0")

initStocks  <- list(Susceptible = "S0", Infected = 10, Recovered = 0)
stan_tp     <- paste(
  "transformed parameters {",
  "  real y_hat[n_obs, n_difeq]; // Output from the ODE solver",
  "  real y0[n_difeq]; // Initial conditions",
  "  real incidence[n_obs];",
  "  real recovery[n_obs];",
  "  y0[1] = S0;",
  "  y0[2] = 10;",
  "  y0[3] = 0;",
  "  y_hat = integrate_ode_rk45(SIR, y0, t0, ts, params, x_r, x_i);",
  "  incidence[1] =  y_hat[1, 2] + y_hat[1, 3] - y0[2] - y0[3];",
  "  recovery[1] = y_hat[1, 3] - y0[3];",
  "  for (i in 1:n_obs-1) {",
  "    incidence[i + 1] = y_hat[i + 1, 2] + y_hat[i + 1, 3] - y_hat[i, 2] - y_hat[i, 3] + 0.000001; ",
  "    recovery[i + 1] = y_hat[i + 1, 3] - y_hat[i, 3] + 0.000001;",
  "  }",
  "}", sep = "\n")

stan_fits_2_datasets <- lapply(sus_priors, function(prior) {
  model_text <- c(
  "params[1] ~ uniform(0, 500)",
  "params[2] ~ uniform(0, 20)",
  prior,
  "y ~ poisson(incidence)",
  "y2 ~ poisson(recovery)"
  )
  
  stan_model  <- generate_model_text(model_text)
  
  stan_text <- paste(stan_fun, stan_data, stan_td , stan_par,
                     stan_tp, stan_model, sep = "\n")
  
  create_stan_file(stan_text, "SIR_1.1.3.2.stan")
  
  stan_d <- list(n_obs    = length(synthetic_incidence), n_params = 2, 
                 n_difeq  = 3, # number of differential equations
                 y = synthetic_incidence, y2 = R_data$recovery, t0 = 0, 
                 ts = 1:length(synthetic_incidence))

  # Test / debug the model:
  test <- stan("SIR_1.1.3.2.stan", data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)
  
  
  # Fit and sample from the posterior
  stan_fit <- stan(fit = test, data = stan_d, chains = 3, warmup = 2000,
                   iter   = 4000, cores  = 3, seed = 1825157671)
  
})
```

```{r}
mcmc_pairs(stan_fits_2_datasets[[1]], pars = c("params[1]", "params[2]", "S0"))
```

```{r}
mcmc_pairs(stan_fits_2_datasets[[2]], pars = c("params[1]", "params[2]", "S0"))
```

```{r}
mcmc_pairs(stan_fits_2_datasets[[3]], pars = c("params[1]", "params[2]", "S0"))
```

#### 1.1.3.2.4 Calibration

```{r}
sim_dfs <- map2(stan_fits_2_datasets, sus_priors, function(fit, label) {
  posterior_df <- as.data.frame(fit) %>%
    rename(effective_contacts = 'params[1]',
           recoveryProportion = 'params[2]') %>% 
    mutate(recoveryTime = 1 / recoveryProportion)
  
  SIR_obj <- SIR(
  initInfected = 10,
  initSusceptible = mean(posterior_df$S0),
  effectiveContacts = mean(posterior_df$effective_contacts), 
  recoveryTime = mean(posterior_df$recoveryTime))
  
  recovery_df <- generate_recovery_df(SIR_obj) %>% 
    mutate(model = label)
  
  list(incidence_df = SIR_obj$incidence_data %>% mutate(model = label),
       recovery_df  = recovery_df)

})

actual_incidence <- map_df(sus_priors, function(prior) {
  SIR_df %>% mutate(model = prior, source = "actual data", 
                    variable = "Incidence") %>% 
    rename(value = incidence)
} )

inc_comparison_df <- map_df(sim_dfs, "incidence_df") %>% 
  mutate(variable = "Incidence", source = "simulated") %>% 
  rename(value = incidence) %>% bind_rows(actual_incidence)

actual_recovery  <- map_df(sus_priors, function(prior) {
  R_data %>% mutate(model = prior, source = "actual data",
                    variable = "Recovery") %>% 
  rename(value = recovery)
})

rec_comparison_df <- map_df(sim_dfs, "recovery_df") %>% 
  mutate(variable = "Recovery", source = "simulated") %>%
  rename(value = recovery) %>% bind_rows(actual_recovery)

comparison_df     <- bind_rows(inc_comparison_df, rec_comparison_df)

ggplot(comparison_df, aes(x = time, y = value)) +
  geom_line(aes(colour = source, group = source), alpha = 0.5) +
  facet_grid(vars(variable), vars(model)) +
  theme_test()
```


\newpage
## 1.2 SEIR

```{r transformed_params_SEIR_cum}
model_file       <- "./deterministic_models/SEIR_cumulative.stmx"
mdl              <- read_xmile(model_file)
counter          <- 0

stan_init_stocks <- sapply(mdl$description$levels, function(level) {
  counter <<- counter + 1
  paste0("  y0[", counter, "] = ", level$initValue, ";")
}) %>% paste(collapse = "\n")

stan_tp_cum <- paste(
  "transformed parameters{",
  "  real y_hat[n_obs, n_difeq]; // Output from the ODE solver",
  "  real y0[n_difeq]; // Initial conditions",
  "  real cum_inc[n_obs];",
  stan_init_stocks,
  "  y_hat = integrate_ode_rk45(SEIR_cum, y0, t0, ts, params, x_r, x_i);",
  "  for (i in 1:n_obs) {",
  "    cum_inc[i] = y_hat[i, 4];",
  
  "  }",
  "}", sep = "\n")
```


### 1.2.1 Fit one parameter (Contact rate)

```{r th_SEIR_one_param, cache = TRUE}
func_params <- list(recovery_delay = 0.5, latent_period = 1)
stan_fun    <- generate_stan_function("SEIR", func_params)
initStocks  <- list(Susceptible = 990, Exposed = 0, Infected = 10, Recovered = 0)
stan_td     <- generate_transformed_data_block()
stan_tp     <- generate_transformed_parameters("SEIR", initStocks)
```


```{r th_SEIR_one_param_normal, cache = TRUE}

stan_data   <- generate_data_block("normal")
stan_params <- generate_parameters_block("normal")

normal_model_1_params_SEIR <- c(
  "params[1] ~ uniform(0, 500)",
  "sigma     ~ cauchy( 0 , 2 )",
  "y         ~ normal(incidence, sigma)"
)
stan_model  <- generate_model_text(normal_model_1_params_SEIR)

stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp, stan_model, sep = "\n")

create_stan_file(stan_text, "SEIR_normal.stan")

stan_fit_normal <- NULL

stan_fit_normal <- fit_stan_model(
  stan_file = "SEIR_normal.stan", n_constants = 1, 
  incidence_data = synthetic_incidence2, warm_up = 2000, iterations = 4000,
  seed = 1010839870, chains = 3, n_difeq = 4)
```

```{r g_th_SEIR_one_param_normal}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"))

graph_inputs <- generate_graph_inputs(
  stan_fit = stan_fit_normal,
  pars = "effective_contacts",
  rename_pars = rename_pars,
  x_pos          = c(1.0025),
  y_pos          = c(500),
  y_pos_median   = c(450),
  y_pos_interval = c(400))

g1 <- draw_multiple_densities(graph_inputs$densities, graph_inputs$stats_df,
                             text_size = 2)

g1 <- g1 + theme(plot.title = element_text(color = "#404040", size = 8)) +
  labs(title = "Incidence fit - Normal")
```

```{r th_SEIR_one_param_poisson, cache = TRUE}
source('./stan_utils.R')

stan_data   <- generate_data_block("poisson")
stan_params <- generate_parameters_block("poisson")

poisson_model_1_param <- c(
  "params[1] ~ uniform(0, 500)",
  "y         ~ poisson(incidence)"
)

stan_model  <- generate_model_text(poisson_model_1_param)

stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp, stan_model, sep = "\n")

create_stan_file(stan_text, "SEIR_poisson.stan")

stan_fit_poisson <- NULL
stan_fit_poisson <- fit_stan_model(
  stan_file = "SEIR_poisson.stan", n_constants = 1, 
  incidence_data = synthetic_incidence2, warm_up = 2000, iterations = 4000, 
  seed = 1600632916, chains = 3, n_difeq = 4)
```

```{r g_th_SEIR_one_param_poisson}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"))

graph_inputs <- generate_graph_inputs(
  stan_fit = stan_fit_poisson,
  pars = "effective_contacts",
  rename_pars = rename_pars,
  x_pos          = c(1.030),
  y_pos          = c(25),
  y_pos_median   = c(22),
  y_pos_interval = c(19))

g2 <- draw_multiple_densities(graph_inputs$densities, graph_inputs$stats_df,
                             text_size = 2)

g2 <- g2 + theme(plot.title = element_text(color = "#404040", size = 8)) +
  labs(title = "Incidence fit - Poisson") 

```

```{r fit_1_param_cml_SEIR_normal, cache = TRUE}
model_file       <- "./deterministic_models/SEIR_cumulative.stmx"
mdl              <- read_xmile(model_file)
stan_fun         <- create_stan_function(model_file, "SEIR_cum", pars = "ec")
stan_td          <- generate_transformed_data_block()
stan_data        <- generate_data_block("normal")
stan_td          <- generate_transformed_data_block()
stan_params      <- generate_parameters_block("normal")
normal_model     <- c("params[1] ~ uniform(0, 500)", "sigma ~ cauchy(0, 2)",
                      "y ~ normal(cum_inc, sigma)")
stan_model       <- generate_model_text(normal_model)

stan_text        <- paste(stan_fun, stan_data, stan_td, stan_params, stan_tp_cum,
                          stan_model, sep = "\n")

filename <- "SIR_1.2.1_cml_normal.stan"
create_stan_file(stan_text, filename)

stan_d <- list(n_obs   = length(SEIR_cml_infected),
              n_params = 1, 
              n_difeq  = 5, # number of differential equations
              y        = SEIR_cml_infected,
              t0       = 0,
              ts       = 1:length(SEIR_cml_infected))

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
             verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
fit_1.2.1_cml_poisson <- stan(
  fit = test, data = stan_d, chains = 3, warmup = 2000, iter   = 4000, 
  cores  = 3, seed = 1449968666, refresh = 5)
```

```{r g_1_param_cml_SEIR_normal}
source('./graphs.R')
posterior_df <- as.data.frame(fit_1.2.1_cml_poisson)
specs_list <- list(x_pos = 1.0001, ypos_mean = 6000, ypos_median = 5500, 
                   text_size = 2, ypos_interval = 5000, 
                   title = "Cumulative fitting - Normal", xlabel = "")

g3 <- draw_density(posterior_df$`params[1]`, specs_list)
```


```{r g_th_SEIR_one_param, fig.height = 5}
grid.arrange(g1, g2, g3, nrow = 2,ncol = 2)
```

### 1.2.2 Fit two parameters (Contact rate & latent period)


```{r th_SEIR_two_param, cache = TRUE}
source('./stan_utils.R')
func_params <- list(recovery_delay = 0.5)
stan_fun    <- generate_stan_function("SEIR", func_params)
initStocks  <- list(Susceptible = 990, Exposed = 0, Infected = 10, Recovered = 0)
stan_td     <- generate_transformed_data_block()
stan_tp     <- generate_transformed_parameters("SEIR", initStocks)
```


#### 1.2.2.1 Normal distribution

```{r th_SEIR_two_param_normal, cache = TRUE}
source('./stan_utils.R')

stan_data   <- generate_data_block("normal")
stan_params <- generate_parameters_block("normal")

normal_model_2_params_SEIR <- c(
  "params[1] ~ uniform(0, 500)",
  "params[2] ~ uniform(0, 20)",
  "sigma     ~ cauchy( 0 , 2 )",
  "y         ~ normal(incidence, sigma)"
)
stan_model  <- generate_model_text(normal_model_2_params_SEIR)

stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp, stan_model, sep = "\n")

filename  <- "SEIR_1221_inc.stan"

create_stan_file(stan_text, filename)

fit_1.2.2.1_inc <- fit_stan_model(
  stan_file      = filename,
  n_constants    = 2,
  incidence_data = synthetic_incidence2,
  warm_up        = 2000,
  iterations     = 4000,
  seed           = 2008167798,
  chains         = 3,
  n_difeq        = 4)
```

```{r, fig.height= 4}
np <- nuts_params(fit_1.2.2.1_inc )

mcmc_pairs(
  fit_1.2.2.1_inc , np = np, pars = c("params[1]", "params[2]", "sigma"),
  max_treedepth = with(np, -1 + max(Value[Parameter == "treedepth__"])))

stan_trace(fit_1.2.2.1_inc , pars = c("params[1]", "params[2]")) +
  labs(title = "Fitting incidence rate")
```

```{r fit_cml_SEIR_2_params, cache = TRUE}
model_file       <- "./deterministic_models/SEIR_cumulative.stmx"
mdl              <- read_xmile(model_file)
stan_fun         <- create_stan_function(
  model_file, "SEIR_cum", pars = c("ec", "infectious_proportion"))

stan_td          <- generate_transformed_data_block()
stan_data        <- generate_data_block("normal")
stan_td          <- generate_transformed_data_block()
stan_params      <- generate_parameters_block("normal")
normal_model     <- c("params[1] ~ uniform(0, 500)", 
                      "params[2] ~ uniform(0, 20)",
                      "sigma ~ cauchy(0, 2)",
                      "y ~ normal(cum_inc, sigma)")

stan_model       <- generate_model_text(normal_model)

stan_text        <- paste(stan_fun, stan_data, stan_td, stan_params, stan_tp_cum,
                          stan_model, sep = "\n")

filename <- "SIR_1221_cml_normal.stan"
create_stan_file(stan_text, filename)

stan_d <- list(n_obs   = length(SEIR_cml_infected),
              n_params = 2, 
              n_difeq  = 5, # number of differential equations
              y        = SEIR_cml_infected,
              t0       = 0,
              ts       = 1:length(SEIR_cml_infected))

# Test / debug the model:
test <- stan(filename, data = stan_d, chains = 1, iter = 10,
             verbose = FALSE, refresh = 0)

# Fit and sample from the posterior
fit_1.2.2.1_cml_normal <- stan(
  fit = test, data = stan_d, chains = 3, warmup = 2000, iter   = 4000, 
  cores  = 3, seed = 1449968666, refresh = 5)
```

```{r}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"),
                    list(new = "incubation_proportion", old = "params[2]"))

graph_inputs <- generate_graph_inputs(
  stan_fit = fit_1.2.2.1_cml_normal,
  pars = c("effective_contacts", "latent_period"),
  rename_pars = rename_pars,
  x_pos          = c(1.00005, 1.0001),
  y_pos          = c(2000, 360),
  y_pos_median   = c(1900, 340),
  y_pos_interval = c(1800, 320))

g <- draw_multiple_densities(graph_inputs$densities, graph_inputs$stats_df,
                             text_size = 2) +
  labs(title = "Cumulative fitting - Normal")
print(g)
```


#### 1.2.2.2 Poisson distribution

```{r th_SEIR_poisson_two_params}
source('./stan_utils.R')

func_params <- list(recovery_delay = 0.5)
stan_fun    <- generate_stan_function("SEIR", func_params)
stan_data   <- generate_data_block("poisson")
stan_td     <- generate_transformed_data_block()
stan_params <- generate_parameters_block("poisson")
initStocks  <- list(Susceptible = 990, Exposed = 0, Infected = 10, Recovered = 0)
stan_tp     <- generate_transformed_parameters("SEIR", initStocks)

poisson_model_2_params_SEIR <- c(
  "params[1] ~ uniform(0, 500)",
  "params[2] ~ uniform(0, 20)", 
  "y         ~ poisson(incidence)"
)
stan_model  <- generate_model_text(poisson_model_2_params_SEIR)

stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp, stan_model, sep = "\n")

create_stan_file(stan_text, "SEIR_poisson1222.stan")
```


#### 1.2.2.2.1 Right model (SEIR fitting SEIR)

```{r th_SEIR_two_param_poisson, cache = TRUE}
source('./stan_utils.R')

sf_right <- NULL
sf_right <- fit_stan_model(
  stan_file = "SEIR_poisson1222.stan", n_constants = 2, 
  incidence_data = synthetic_incidence2, warm_up = 2000, iterations = 4000, 
  seed = 435686929, chains = 3, n_difeq = 4)
```

```{r, fig.height= 4}
mcmc_pairs(sf_right, pars = c("params[1]", "params[2]"))
```

```{r}
source('./graphs.R')

rename_pars <- list(list(new = "effective_contacts", old = "params[1]"),
                    list(new = "incubation_proportion", old = "params[2]"))

graph_inputs <- generate_graph_inputs(
  stan_fit = sf_right,
  pars = c("effective_contacts", "latent_period"),
  rename_pars = rename_pars,
  x_pos          = c(1.06, 1.25),
  y_pos          = c(8, 2.5),
  y_pos_median   = c(7.5, 2.4),
  y_pos_interval = c(7, 2.3))

g <- draw_multiple_densities(graph_inputs$densities, graph_inputs$stats_df,
                             text_size = 2)
print(g)
```


#### 1.2.2.2.2 Wrong model (SEIR fitting SIR)

```{r th_SEIR_poisson_two_params_wrong, cache = TRUE}
source('./stan_utils.R')

stan_fit_wrong <- fit_stan_model(
  stan_file = "SEIR_poisson1222.stan", n_constants = 2, synthetic_incidence,
  warm_up = 2000, iterations = 4000, seed = 28803987, n_difeq = 4)
```

```{r, fig.height= 4}
mcmc_pairs(stan_fit_wrong, np = nuts_params(stan_fit_wrong), 
           pars = c("params[1]", "params[2]"))
```


### 1.2.3 Fit three parameters (Contact rate, latent period & recovery time)

#### 1.2.3.1 Normal distribution

```{r th_SEIR_three_params_normal, cache=TRUE}
source('./stan_utils.R')

stan_fun    <- generate_stan_function("SEIR")
stan_data   <- generate_data_block("normal")
stan_td     <- generate_transformed_data_block()
stan_params <- generate_parameters_block("normal")
initStocks  <- list(Susceptible = 990, Exposed = 0, Infected = 10,
                    Recovered = 0)
stan_tp     <- generate_transformed_parameters("SEIR", initStocks)


create_input_for_model_block <- function(prior_incubation_proportion,
                                         prior_recovery_proportion) {
  
   c("params[1] ~ uniform(0, 500)", prior_incubation_proportion,
     prior_recovery_proportion, "sigma     ~ cauchy( 0 , 2 )",
     "y         ~ normal(incidence, sigma)")
}

priors_list <- list(
  list(label = "Flat prior",
       incubation_proportion = "params[2] ~ uniform(0, 20)",
       recovery_proportion = "params[3] ~ uniform(0, 20)"),
  list(label = "Regularising prior",
       incubation_proportion = "params[2] ~ normal(0, 10)",
       recovery_proportion = "params[3] ~ normal(0, 10)"),
  list(label = "Strong prior - incorrect",
       incubation_proportion = "params[2] ~ normal(0, 10)",
       recovery_proportion = "params[3] ~ normal(0.35, 0.01)"),
  list(label = "Strong prior - correct",
       incubation_proportion = "params[2] ~ normal(0, 10)",
       recovery_proportion = "params[3] ~ normal(0.50, 0.01)"))

stan_fits_normal <- lapply(priors_list, function(priors) {
  normal_model_3_params_SEIR <- create_input_for_model_block(
    priors$incubation_proportion, priors$recovery_proportion)
  
  plot_label  <<- priors$label
  stan_model  <- generate_model_text(normal_model_3_params_SEIR)

  stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp, stan_model, sep = "\n")

  create_stan_file(stan_text, "SEIR1231.stan")
  
  stan_fit_normal <- NULL
  stan_fit_normal <- fit_stan_model(
    stan_file = "SEIR1231.stan", n_constants = 3,
    incidence_data = synthetic_incidence2, warm_up = 1000, iterations = 2000,
    seed = 264842530, chains = 3, n_difeq = 4)
})
```

```{r, fig.height=4}

stan_fit <- stan_fits_normal[[1]]
np <- nuts_params(stan_fit)

mcmc_pairs(
  stan_fit, np = np,
  pars = c("params[1]", "params[2]", "params[3]", "sigma"),
  max_treedepth = with(np, -1 + max(Value[Parameter == "treedepth__"])),
  grid_args = list(top = "Flat prior"))

```

\hfill\break
```{r, fig.height=4}
stan_fit <- stan_fits_normal[[2]]
np <- nuts_params(stan_fit)
mcmc_pairs(
  stan_fit, np = np,
  pars = c("params[1]", "params[2]", "params[3]", "sigma"),
  max_treedepth = with(np, -1 + max(Value[Parameter == "treedepth__"])),
  grid_args = list(top = "Regularising prior" ))
```


```{r, fig.height=4}
stan_fit <- stan_fits_normal[[3]]
np <- nuts_params(stan_fit)
mcmc_pairs(
  stan_fit, np = np,
  pars = c("params[1]", "params[2]", "params[3]", "sigma"),
  max_treedepth = with(np, -1 + max(Value[Parameter == "treedepth__"])),
  grid_args = list(top = "Strong prior - incorrect"))
```
\hfill\break

```{r, fig.height=4}
stan_fit <- stan_fits_normal[[4]]
np <- nuts_params(stan_fit)
mcmc_pairs(
  stan_fit, np = np,
  pars = c("params[1]", "params[2]", "params[3]", "sigma"),
  max_treedepth = with(np, -1 + max(Value[Parameter == "treedepth__"])),
  grid_args = list(top = "Strong prior - correct" ))
```


#### 1.2.3.2 Poisson distribution

```{r th_SEIR_three_params_poisson, cache = TRUE}
source('./stan_utils.R')

stan_fun    <- generate_stan_function("SEIR")
stan_data   <- generate_data_block("poisson")
stan_td     <- generate_transformed_data_block()
stan_params <- generate_parameters_block("poisson")
initStocks  <- list(Susceptible = 990, Exposed = 0, Infected = 10, 
                    Recovered = 0)
stan_tp     <- generate_transformed_parameters("SEIR", initStocks)

create_input_for_model_block <- function(prior_incubation_proportion,
                                         prior_recovery_proportion) {
  
   c("params[1] ~ uniform(0, 20)", prior_incubation_proportion,
     prior_recovery_proportion,"y ~ poisson(incidence)")
}

priors_list <- list(
  list(label = "Flat prior",
       incubation_proportion = "params[2] ~ uniform(0, 20)",
       recovery_proportion = "params[3] ~ uniform(0, 20)"),
  list(label = "Regularising prior",
       incubation_proportion = "params[2] ~ normal(0, 10)",
       recovery_proportion = "params[3] ~ normal(0, 10)"),
  list(label = "Strong prior - incorrect",
       incubation_proportion = "params[2] ~ normal(0, 10)",
       recovery_proportion = "params[3] ~ normal(0.35, 0.01)"),
  list(label = "Strong prior - correct",
       incubation_proportion = "params[2] ~ normal(0, 10)",
       recovery_proportion = "params[3] ~ normal(0.50, 0.01)"))

stan_fits_poisson <- lapply(priors_list, function(priors) {
  poisson_model_3_params_SEIR <- create_input_for_model_block(
    priors$incubation_proportion, priors$recovery_proportion)
  
  plot_label  <<- priors$label
  stan_model  <- generate_model_text(poisson_model_3_params_SEIR)

  stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp, stan_model, sep = "\n")
  
  filename <- paste0("SEIR1232_", priors$label, ".stan")

  create_stan_file(stan_text, filename)
  
  stan_fit_poisson <- NULL
  stan_fit_poisson <- fit_stan_model(
    stan_file = filename, n_constants = 3,
    incidence_data = synthetic_incidence2, warm_up = 1000, iterations = 2000,
    seed = 264842530, chains = 3, n_difeq = 4)
})
```

```{r p_SEIR_poisson_3_params_flat_prior, fig.height=4}

stan_fit <- stan_fits_poisson[[1]]
np <- nuts_params(stan_fit)

mcmc_pairs(
  stan_fit, np = np,
  pars = c("params[1]", "params[2]", "params[3]"),
  max_treedepth = with(np, -1 + max(Value[Parameter == "treedepth__"])),
  grid_args = list(top = "Flat prior"))

```

```{r p_SEIR_poisson_3_params_regularising_prior, fig.height=4}
stan_fit <- stan_fits_poisson[[2]]
np <- nuts_params(stan_fit)

mcmc_pairs(
  stan_fit, np = np,
  pars = c("params[1]", "params[2]", "params[3]"),
  max_treedepth = with(np, -1 + max(Value[Parameter == "treedepth__"])),
  grid_args = list(top = "Regularising prior"))
```

```{r, fig.height=4}
stan_fit <- stan_fits_poisson[[3]]
np <- nuts_params(stan_fit)

mcmc_pairs(
  stan_fit, np = np,
  pars = c("params[1]", "params[2]", "params[3]"),
  max_treedepth = with(np, -1 + max(Value[Parameter == "treedepth__"])),
  grid_args = list(top = "Strong prior - incorrect"))
```

```{r, fig.height=4}
stan_fit <- stan_fits_poisson[[4]]
np <- nuts_params(stan_fit)

mcmc_pairs(
  stan_fit, np = np,
  pars = c("params[1]", "params[2]", "params[3]"),
  max_treedepth = with(np, -1 + max(Value[Parameter == "treedepth__"])),
  grid_args = list(top = "Strong prior - correct"))
```

\newpage

# 2. SYNTHETIC DATA FROM STOCHASTIC MODELS

## 2.1 SIR

```{r SIR_stochastic_data}
library(SimInf)

SIR_deterministic_incidence <- SIR_df %>% mutate(model = "Deterministic")

set.seed(12)
n         <- 1000
u0        <- data.frame(S = rep(990, n), I = rep(10, n), R = rep(0, n))
tspan     <- seq(from = 0, to = 30, by = 1)
model     <- SimInf::SIR(u0 = u0, tspan = tspan, beta = 1, gamma = 0.5)
result    <- run(model = model, threads = 1)
result_df <- trajectory(result)

stochastic_incidences <- result_df %>% group_by(node) %>% 
  mutate(eI = I + R,
         incidence = eI - lag(eI, default = eI[1]),
         incidence = round(incidence)) %>% 
  select(time, incidence) %>% filter(time != 0) %>% ungroup()

SIR_stochastic_incidence <- stochastic_incidences %>% group_by(time) %>% 
  summarise(incidence = mean(incidence)) %>% 
  ungroup() %>% mutate(model = "Stochastic (mean)")


comparison_df <- bind_rows(SIR_deterministic_incidence, SIR_stochastic_incidence) 

g1 <- comparison_df %>% 
  ggplot(aes(x = time, y = incidence)) +
  geom_line(aes(group = model, colour = model), alpha = 0.8) +
  geom_point(aes(shape = model, colour = model), alpha = 0.8) +
  scale_colour_manual(values = pal_jco()(2)) +
  theme_test() +
  theme(legend.position = "bottom",
        legend.title = element_text(colour = "grey", size = 8),
        legend.text = element_text(size = 8)) +
  labs(subtitle = "Comparison of SIR models")

set.seed(4)
nodes <- sample(1:1000, 50) %>% sort()

sample_incidences <- stochastic_incidences %>% filter(node %in% nodes) %>% 
  mutate(node = as.factor(node))

sample_cml_incidences <- sample_incidences %>% group_by(node) %>% 
  mutate(cml_incidence = cumsum(incidence)) %>% arrange(node, time)

five_incidences <- sample_incidences %>% filter(node %in% nodes[1:5])

g2 <- ggplot(five_incidences, aes(x = time, y = incidence, group = node)) +
  geom_line(aes(colour = node), alpha = 0.8) +
  theme_test() +
  theme(legend.position = "none") +
  labs(subtitle = "Sample of incidences")

grid.arrange(g1, g2, nrow = 1)


```

### 2.1.1 Fitting one parameter (Effective contacts)

```{r}
func_params <- list(recovery_delay = 0.5)
stan_fun    <- generate_stan_function("SIR", func_params)
stan_td     <- generate_transformed_data_block()
initStocks  <- list(Susceptible = 990, Infected = 10, Recovered = 0)
stan_tp     <- generate_transformed_parameters("SIR", initStocks)
```


```{r fit_1_param_stochastic_SIR_normal, cache = TRUE}
stan_data   <- generate_data_block("normal")
stan_params <- generate_parameters_block("normal")
stan_model  <- generate_stan_model(likelihood = "normal",
                                  n_params = 1)

stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp, stan_model, sep = "\n")

filename    <- "SIR_211_normal.stan"
create_stan_file(stan_text, filename)
compiled_sm <- stan_model(filename)


fits_2.2.1_normal <- lapply(nodes, function(node_param, sample_incidences) {
  sample_incidence <- sample_incidences %>% filter(node == node_param) %>% 
  pull(incidence)
  
  stan_d <- list(n_obs   = length(sample_incidence),
              n_params = 1, 
              n_difeq  = 3, # number of differential equations
              y        = sample_incidence,
              t0       = 0,
              ts       = 1:length(sample_incidence))
  
  # Test / debug the model:
  test <- sampling(object = compiled_sm, data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)
  
  # Fit and sample from the posterior
  fit_2.2.1_normal <- sampling(
    object = compiled_sm, data = stan_d, verbose = FALSE,chains = 3, 
    warmup = 2000, iter   = 4000, cores  = 3, seed = 559264381, refresh = 5)
  
}, sample_incidences = sample_incidences)
```

```{r}
summary_fits <- map2_df(fits_2.2.1_normal, nodes, function(fit, node) {
  posterior_df   <- as.data.frame(fit) %>% pull(`params[1]`)
  mean_posterior <- mean(posterior_df)
  intervals <- HPDI(posterior_df, prob = 0.95)
  data.frame(node = node, mean = mean_posterior, lower = intervals[[1]], 
             upper = intervals[[2]])
})

g1 <- ggplot(summary_fits, aes(x = as.factor(node), y = mean)) +
  geom_errorbar(aes(ymin=lower, ymax = upper), width =.1) +
  geom_point(size=3, shape=21, fill="white") +
  geom_hline(yintercept = 1, linetype = "dashed", alpha = 0.5) +
  theme_test() +
  theme(axis.text.x = element_blank()) +
  labs(subtitle = "Fitting rate - Normal")

```

```{r fit_1_param_stochastic_SIR_poisson, cache = TRUE}
stan_data   <- generate_data_block("poisson")
stan_params <- generate_parameters_block("poisson")
stan_model  <- generate_stan_model(likelihood = "poisson", n_params = 1)

stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp, stan_model, sep = "\n")

filename <- "SIR_211_poisson.stan"
create_stan_file(stan_text, filename)
compiled_sm <- stan_model(filename)

fits_2.2.1_poisson <- lapply(nodes, function(node_param, sample_incidences) {
  sample_incidence <- sample_incidences %>% filter(node == node_param) %>% 
  pull(incidence)
  
  stan_d <- list(n_obs   = length(sample_incidence),
              n_params = 1, 
              n_difeq  = 3, # number of differential equations
              y        = sample_incidence,
              t0       = 0,
              ts       = 1:length(sample_incidence))
  
  # Test / debug the model:
  test <- sampling(compiled_sm, data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)
  
  # Fit and sample from the posterior
  fit_2.2.1_poisson <- sampling(
    compiled_sm, data = stan_d, chains = 3, warmup = 2000, iter   = 4000, 
    cores  = 3, seed = 559264381, refresh = 5)
  
}, sample_incidences = sample_incidences)
```

```{r}
summary_fits <- map2_df(fits_2.2.1_poisson, nodes, function(fit, node) {
  posterior_df   <- as.data.frame(fit) %>% pull(`params[1]`)
  mean_posterior <- mean(posterior_df)
  intervals <- HPDI(posterior_df, prob = 0.95)
  data.frame(node = node, mean = mean_posterior, lower = intervals[[1]], 
             upper = intervals[[2]])
})

g2 <- ggplot(summary_fits, aes(x = as.factor(node), y = mean)) +
  geom_errorbar(aes(ymin=lower, ymax = upper), width =.1) +
  geom_point(size = 3, shape = 21, fill="white") +
  geom_hline(yintercept = 1, linetype = "dashed", alpha = 0.5) +
  theme_test() +
  theme(axis.text.x = element_blank()) +
  labs(subtitle = "Fitting rate - Poisson")

```

```{r cml_SIR_1_param_stochastic, cache = TRUE}
model_file       <- "./deterministic_models/SIR_cumulative.stmx"
stan_fun         <- create_stan_function(model_file, "SIR_cum", pars = "ec")
mdl              <- read_xmile(model_file)
counter          <- 0
levels           <- mdl$description$levels


stan_init_stocks <- sapply(levels, function(level) {
  counter <<- counter + 1
  paste0("  y0[", counter, "] = ", level$initValue, ";")
}) %>% paste(collapse = "\n")

stan_tp_cum <- paste(
  "transformed parameters{",
  "  real y_hat[n_obs, n_difeq]; // Output from the ODE solver",
  "  real y0[n_difeq]; // Initial conditions",
  "  real cum_inc[n_obs];",
  stan_init_stocks,
  "  y_hat = integrate_ode_rk45(SIR_cum, y0, t0, ts, params, x_r, x_i);",
  "  for (i in 1:n_obs) {",
  "    cum_inc[i] = y_hat[i, 4];",
  
  "  }",
  "}", sep = "\n")

stan_data   <- generate_data_block("normal")
stan_params <- generate_parameters_block("normal")

stan_model_text <- c(
  "  params[1] ~ uniform(0, 500)",
  "  sigma     ~ cauchy( 0 , 2 )",
  "  y         ~ normal(cum_inc, sigma)"
)

stan_model  <- generate_model_text(stan_model_text)
stan_text   <- paste(stan_fun, stan_data, stan_td, stan_params,
                     stan_tp_cum, stan_model, sep = "\n")

filename <- "SIR_2.1.1_normal_cml.stan"
create_stan_file(stan_text, filename)
compiled_sm <- stan_model(filename)

fits_2.2.1_nrm_cml <- lapply(nodes, function(node_param, sample_cml_incidences) {
  sample_cml_incidence <- sample_cml_incidences %>% filter(node == node_param) %>% 
  pull(cml_incidence)
  
  stan_d <- list(n_obs   = length(sample_cml_incidence),
              n_params = 1, 
              n_difeq  = 4, # number of differential equations
              y        = sample_cml_incidence,
              t0       = 0,
              ts       = 1:length(sample_cml_incidence))
  
  # Test / debug the model:
  test <- sampling(compiled_sm, data = stan_d, chains = 1, iter = 10,
               verbose = FALSE, refresh = 0)
  
  # Fit and sample from the posterior
  fit_2.2.1_nrm_cml <- sampling(
    compiled_sm, data = stan_d, chains = 3, warmup = 2000, iter   = 4000, 
    cores  = 3, seed = 1534395396, refresh = 5)
  
}, sample_cml_incidences = sample_cml_incidences)
```


```{r}
summary_fits <- map2_df(fits_2.2.1_nrm_cml, nodes, function(fit, node) {
  posterior_df   <- as.data.frame(fit) %>% pull(`params[1]`)
  mean_posterior <- mean(posterior_df)
  intervals <- HPDI(posterior_df, prob = 0.95)
  data.frame(node = node, mean = mean_posterior, lower = intervals[[1]], 
             upper = intervals[[2]])
})

g3 <- ggplot(summary_fits, aes(x = as.factor(node), y = mean)) +
  geom_errorbar(aes(ymin=lower, ymax = upper), width =.1) +
  geom_point(size=3, shape=21, fill="white") +
  geom_hline(yintercept = 1, linetype = "dashed", alpha = 0.5) +
  theme_test() +
  theme(axis.text.x = element_blank()) +
  labs(subtitle = "Fitting cumulative - Normal")

```

```{r, fig.height = 6}
grid.arrange(g1, g2, g3, ncol = 1)
```

```{r}
model_file <- "./deterministic_models/SIR_cumulative.stmx"
mdl        <- read_xmile(model_file)
ds_consts  <- mdl$deSolve_components$consts
ds_func    <- mdl$deSolve_components$func
ds_stocks  <- mdl$deSolve_components$stocks

library(deSolve)

# Create time vector
simtime <- seq(0, 30, by = 1 / 128)

generate_sir_inc <- function() {
  
  function(pars) {
    ds_consts["ec"] <- pars[[1]]
    ds_consts["recovery_proportion"] <- pars[[2]]
    
    o <- ode(
      y     = ds_stocks, times = simtime,
      func  = ds_func,
      parms = ds_consts, method = "rk4") %>% data.frame() %>% 
      filter(time - trunc(time) == 0) %>% 
    mutate(eI = I + R, 
           incidence = eI - lag(eI, default = eI[1]),
           incidence = round(incidence)) %>% 
    select(time, incidence) %>% 
    filter(time != 0)
   }
}

sir_function <- generate_sir_inc()

poisson.loglik <-  function (params) {
  sim <- sir_function(params) %>% pull(incidence)
  -1 * sum(dpois(x = sim, lambda = synthetic_incidence, log = TRUE))
}

sim_labels <- paste0("init_", 1:10)

set.seed(45)

inits_list <- lapply(sim_labels, function(lbl){
  list(label = lbl,
       init_ec = runif(1, 0, 20),
       init_rp = runif(1, 0, 1))
})

inits_list[[11]] <- list(label = "solution",
                        init_ec = 1,
                        init_rp = 0.5)


fits_list <- lapply(inits_list, function(init_obj){
  print(init_obj$label)
  optim_fit <- optim(par = c(init_obj$init_ec, init_obj$init_rp), 
                     fn = poisson.loglik, 
                     method = "Nelder-Mead")
  list(pars = optim_fit$par, log_lik = -1 * optim_fit$value,
       label = init_obj$label)
})

fits_df <- map_df(fits_list, function(fit) {
  pars <- fit$pars
  sir_function(c(pars[[1]], pars[[2]])) %>% 
    mutate(fit = fit$label)
})

fits_df <- fits_df %>% 
  mutate(fit_type = ifelse(fit == "solution", "solution", "fit"))

ggplot(fits_df, aes(x = time, y = incidence)) +
  geom_line(aes(group = fit, colour = fit_type)) +
  scale_colour_manual(values = c("grey", "blue"))

ggplot(fits_df, aes(x = time, y = incidence)) +
  geom_line(aes(group = fit, colour = fit_type)) +
  scale_colour_manual(values = c("grey", "blue")) +
  facet_wrap(~ fit)
```


```{r}
model_file <- "./deterministic_models/SEIR_cumulative.stmx"
mdl        <- read_xmile(model_file)
ds_consts  <- mdl$deSolve_components$consts
ds_func    <- mdl$deSolve_components$func
ds_stocks  <- mdl$deSolve_components$stocks

library(deSolve)

# Create time vector
simtime <- seq(0, 30, by = 1 / 128)

generate_seir_inc <- function() {
  
  function(pars) {
    ds_consts["ec"] <- pars[[1]]
    ds_consts["infectious_proportion"] <- pars[[2]]
    
    o <- ode(
      y     = ds_stocks, times = simtime,
      func  = ds_func,
      parms = ds_consts, method = "rk4") %>% data.frame() %>% 
      filter(time - trunc(time) == 0) %>% 
    mutate(eI = I + R, 
           incidence = eI - lag(eI, default = eI[1]),
           incidence = round(incidence)) %>% 
    select(time, incidence) %>% 
    filter(time != 0)
   }
}

seir_function <- generate_seir_inc()

poisson.loglik <-  function (params) {
  sim <- seir_function(params) %>% pull(incidence)
  -1 * sum(dpois(x = sim, lambda = synthetic_incidence2, log = TRUE))
}

sim_labels <- paste0("init_", 1:30)

set.seed(15)

inits_list <- lapply(sim_labels, function(lbl){
  list(label = lbl,
       init_ec = runif(1, 0, 20),
       init_lp = runif(1, 0, 2))
})

inits_list[[31]] <- list(label = "solution",
                        init_ec = 1,
                        init_lp = 1)


fits_list <- lapply(inits_list, function(init_obj){
  print(init_obj$label)
  optim_fit <- optim(par = c(init_obj$init_ec, init_obj$init_lp), 
                     fn = poisson.loglik, 
                     method = "Nelder-Mead")
  list(pars = optim_fit$par, log_lik = -1 * optim_fit$value,
       label = init_obj$label)
})

fits_df <- map_df(fits_list, function(fit) {
  pars <- fit$pars
  seir_function(c(pars[[1]], pars[[2]])) %>% 
    mutate(fit = fit$label)
})

fits_df <- fits_df %>% 
  mutate(fit_type = ifelse(fit == "solution", "solution", "fit"))

ggplot(fits_df, aes(x = time, y = incidence)) +
  geom_line(aes(group = fit, colour = fit_type)) +
  scale_colour_manual(values = c("grey", "blue"))

ggplot(fits_df, aes(x = time, y = incidence)) +
  geom_line(aes(group = fit, colour = fit_type)) +
  scale_colour_manual(values = c("grey", "blue")) +
  facet_wrap(~ fit)
```

```{r}
model_file <- "./deterministic_models/SEIR_cumulative.stmx"
mdl        <- read_xmile(model_file)
ds_consts  <- mdl$deSolve_components$consts
ds_func    <- mdl$deSolve_components$func
ds_stocks  <- mdl$deSolve_components$stocks

library(deSolve)

# Create time vector
simtime <- seq(0, 30, by = 1 / 128)

generate_seir_inc <- function() {
  
  function(pars) {
    ds_consts["ec"]  <- pars[[1]]
    ds_stocks["S"] <- pars[[2]]
    
    o <- ode(
      y     = ds_stocks, times = simtime,
      func  = ds_func,
      parms = ds_consts, method = "rk4") %>% data.frame() %>% 
      filter(time - trunc(time) == 0) %>% 
    mutate(eI = I + R, 
           incidence = eI - lag(eI, default = eI[1]),
           incidence = round(incidence)) %>% 
    select(time, incidence) %>% 
    filter(time != 0)
   }
}

seir_function <- generate_seir_inc()

poisson.loglik <-  function (params) {
  sim <- seir_function(params) %>% pull(incidence)
  -1 * sum(dpois(x = sim, lambda = synthetic_incidence2, log = TRUE))
}

sim_labels <- paste0("init_", 1:30)

set.seed(15)

inits_list <- lapply(sim_labels, function(lbl){
  list(label = lbl,
       init_ec = runif(1, 0, 20),
       init_S = runif(1, 0, 2000))
})

inits_list[[31]] <- list(label = "solution",
                        init_ec = 1,
                        init_S = 990)


fits_list <- lapply(inits_list, function(init_obj){
  print(init_obj$label)
  optim_fit <- optim(par = c(init_obj$init_ec, init_obj$init_S), 
                     fn = poisson.loglik, 
                     method = "Nelder-Mead")
  list(pars = optim_fit$par, log_lik = -1 * optim_fit$value,
       label = init_obj$label)
})

fits_df <- map_df(fits_list, function(fit) {
  pars <- fit$pars
  seir_function(c(pars[[1]], pars[[2]])) %>% 
    mutate(fit = fit$label)
})

fits_df <- fits_df %>% 
  mutate(fit_type = ifelse(fit == "solution", "solution", "fit"))

ggplot(fits_df, aes(x = time, y = incidence)) +
  geom_line(aes(group = fit, colour = fit_type)) +
  scale_colour_manual(values = c("grey", "blue"))

ggplot(fits_df, aes(x = time, y = incidence)) +
  geom_line(aes(group = fit, colour = fit_type)) +
  scale_colour_manual(values = c("grey", "blue")) +
  facet_wrap(~ fit)
```

